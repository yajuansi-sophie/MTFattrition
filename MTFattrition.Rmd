---
title: "Cohort Trajectory modeling-selected model"
author: "Yajuan Si"
date: "07/01/2021"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
#install.packages(c("tidyverse","mi", "survey", "rpart","gridExtra", "pROC","geepack", "lme4","party","MASS"))
knitr::opts_chunk$set(echo = TRUE)
```



```{r, echo=FALSE, warning=FALSE,include=FALSE}
# options(repos = (ICPSRrepos = "file:I:/R"),
#         pkgType = "win.binary",
#         install.packages.check.source = "no")

#install.packages("tidyverse")
#install.packages("survey")
#install.packages("rpart")
#
#library(rstanarm); library(margins);
library(tidyverse); library(mi); library(survey); library(rpart); library(gridExtra)
library(knitr); library(pROC); library(geepack);  library(lme4);  library(party); library(MASS)

g_legend = function(a.gplot){
  tmp = ggplot_gtable(ggplot_build(a.gplot))
  leg = which(sapply(tmp$grobs, function(x) x$name)=="guide-box")
  legend = tmp$grobs[[leg]]
  return(legend)
}
###data
load("I:/original data/da37072-0001_REST.rda")
data = da37072.0001
rm(da37072.0001)

setwd("I:/WorkingProgramFiles/")
#names(data)
```

## Covariates

```{r, echo=FALSE, warning=FALSE, include=FALSE}
#region
# table(data$V113,useNA="always")
# 
# # #of patients
# table(data$V155,useNA = "always")
# 
# #parent education
# table(data$V363,useNA="always")
# 
# 
# #State
# table(data$V139,useNA = "always")
# 
# #sex
# table(data$V350, useNA = "always")

#race
#table(data$V351, useNA="always")
data = data %>%
  mutate(V351_rc = V351)

data$V351_rc[is.na(data$V351)]= "(99) 99:Missing"

#data$V351_rc[data$V351_rc %in% c("(01) AMER IND:(1)", "(03) CHICANO:(3)", "(04) CUBAN AM:(4)", "(08) PRTCN AM:(8)", "(09) OTH LATIN:(9)")] = "Hispanic"

data = data %>%
  mutate(
    V351_rc = ifelse(V351_rc %in% c("(01) AMER IND:(1)", "(03) CHICANO:(3)", "(04) CUBAN AM:(4)", "(08) PRTCN AM:(8)", "(09) OTH LATIN:(9)"), "Hispanic", 
                     ifelse(V351_rc == "(02) BLACK:(2)", "Black", 
                            ifelse(V351_rc == "(06) WHITE:(6)", "White",
                                   ifelse(V351_rc == "(05) ASIAN AM:(5)", "Asian",
                                          ifelse(V351_rc == "(07) OTHER:(7)", "Other", 
                                                 "Miss")))))

)
#data$V351_rc = droplevels(data$V351_rc)
#levels= c("(02) BLACK:(2)", "(06) WHITE:(6)", "(05) ASIAN AM:(5)", "(07) OTHER:(7)", "Hispanic", "(99) 99:Missing"))

data = data %>%
  mutate(
    V351_rc = ifelse(V101 == 2005 & V416 == "(01) MARKED:(1)" & is.na(V351), "White",
                     ifelse(V101 == 2005 & V410 == "(01) MARKED:(1)" & is.na(V351), "Black",
                        ifelse(V101 == 2005 & V415 == "(01) MARKED:(1)" & is.na(V351), "Asian",
                           ifelse(V101 == 2005 & V414 == "(01) MARKED:(1)" & is.na(V351), "Other",
                                ifelse(V101 == 2005 & (V411 == "(01) MARKED:(1)" | V412 == "(01) MARKED:(1)" | V413 == "(01) MARKED:(1)" |V417 == "(01) MARKED:(1)" |V418 == "(01) MARKED:(1)") & is.na(V351), "Hispanic", V351_rc)))))
)
#data$V351_rc = droplevels(data$V351_rc)
#levels= c("(02) BLACK:(2)", "(06) WHITE:(6)", "(05) ASIAN AM:(5)", "(07) OTHER:(7)", "Hispanic", "(99) 99:Missing"))

data$V351_rc = factor(data$V351_rc)
table(data$V351_rc, useNA="always")

#college
# table(data$V383,useNA = "always")
# table(data$V1767,useNA = "always")
# table(data$V2767,useNA = "always")
# 
# data = data%>%
#   mutate(
#     coll_0 =ifelse(V383=="(04) DEF WILL:(4)", 1, ifelse(V383=="(99) 99:Missing", "Miss",0)),
#      coll_1 =ifelse(V1767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V1767=="(99) 99:Missing", "Miss",0)),
#      coll_2 =ifelse(V2767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V2767=="(99) 99:Missing", "Miss",0)),
#     coll_3 =ifelse(V3767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V3767=="(99) 99:Missing", "Miss",0)),
#     coll_4 =ifelse(V4767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V4767=="(99) 99:Missing", "Miss",0)),
#     coll_5 =ifelse(V5767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V5767=="(99) 99:Missing", "Miss",0)),
#     coll_6 =ifelse(V6767 %in% c("(04) DEF WILL:(4)","(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V6767=="(99) 99:Missing", "Miss",0))
#   )

#1767: V1767 19960:FU R ATTND 4YR CLG
data = data%>%
  mutate(
    coll_0 =ifelse(V383=="(04) DEF WILL:(4)", 1, ifelse(V383=="(99) 99:Missing", "Miss",0)),
     coll_1 =ifelse(V1767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V1767=="(99) 99:Missing", "Miss",0)),
     coll_2 =ifelse(V2767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V2767=="(99) 99:Missing", "Miss",0)),
    coll_3 =ifelse(V3767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V3767=="(99) 99:Missing", "Miss",0)),
    coll_4 =ifelse(V4767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V4767=="(99) 99:Missing", "Miss",0)),
    coll_5 =ifelse(V5767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V5767=="(99) 99:Missing", "Miss",0)),
    coll_6 =ifelse(V6767 %in% c("(05) DO NOW:(5)","(06) HAV DONE:(6)"), 1, ifelse(V6767=="(99) 99:Missing", "Miss",0))
  )

#marrital status
#table(data$V353,useNA = "always")
#table(data$V1748,useNA = "always")
#table(data$V6748,useNA = "always")

data = data%>%
  mutate(
    marry_0 =ifelse(V353=="(01) MARRIED:(1)", 1, ifelse(V353=="(99) 99:Missing", "Miss",0)),
     marry_1 =ifelse(V1748 =="(01) MARRIED:(1)", 1, ifelse(V1748=="(99) 99:Missing", "Miss",0)),
     marry_2 =ifelse(V2748 =="(01) MARRIED:(1)", 1, ifelse(V2748=="(99) 99:Missing", "Miss",0)),
    marry_3 =ifelse(V3748 =="(01) MARRIED:(1)", 1, ifelse(V3748=="(99) 99:Missing", "Miss",0)),
    marry_4 =ifelse(V4748 =="(01) MARRIED:(1)", 1, ifelse(V4748=="(99) 99:Missing", "Miss",0)),
    marry_5 =ifelse(V5748 =="(01) MARRIED:(1)", 1, ifelse(V5748=="(99) 99:Missing", "Miss",0)),
    marry_6 =ifelse(V6748 =="(01) MARRIED:(1)", 1, ifelse(V6748=="(99) 99:Missing", "Miss",0))
  )

#impute incomplete continuous variables: age,  R$/AVG WEEK JOB,  R$/AVG WEEK oth 1-10
mean(data$V34==999); mean(data$V392==99); mean(data$V393==99)

data$V34[data$V34==999] = sample(data$V34[!data$V34==999], sum(data$V34==999),replace = T)
data$V392[data$V392==99] = sample(data$V392[!data$V392==99], sum(data$V392==99),replace = T)
data$V393[data$V393==99] = sample(data$V393[!data$V393==99], sum(data$V393==99),replace = T)
```


##Substance use outcomes



```{r create binary indicators, echo=FALSE, warning=FALSE, include=FALSE}
#Binge drinking
#table(data$V308,useNA = "always")


data = data%>%
  mutate(
    binge_0 =ifelse(V308=="(01) NONE:(1)", 0, ifelse(V308=="(99) 99:Missing", "Miss",1)),
     binge_1 =ifelse(V1708=="(01) NONE:(1)", 0, ifelse(V1708=="(99) 99:Missing", "Miss",1)),
     binge_2 =ifelse(V2708=="(01) NONE:(1)", 0, ifelse(V2708=="(99) 99:Missing", "Miss",1)),
     binge_3 =ifelse(V3708=="(01) NONE:(1)", 0, ifelse(V3708=="(99) 99:Missing", "Miss",1)),
     binge_4 =ifelse(V4708=="(01) NONE:(1)", 0, ifelse(V4708=="(99) 99:Missing", "Miss",1)),
     binge_5 =ifelse(V5708=="(01) NONE:(1)", 0, ifelse(V5708=="(99) 99:Missing", "Miss",1)),
     binge_6 =ifelse(V6708=="(01) NONE:(1)", 0, ifelse(V6708=="(99) 99:Missing", "Miss",1))
  )

#smoking
data = data%>%
  mutate(
    B301_0 =ifelse(V301=="(01) NEVER:(1)", 0, ifelse(V301=="(99) 99:Missing", "Miss",1)),
     B301_1 =ifelse(V1701=="(01) NEVER:(1)", 0, ifelse(V1701=="(99) 99:Missing", "Miss",1)),
     B301_2 =ifelse(V2701=="(01) NEVER:(1)", 0, ifelse(V2701=="(99) 99:Missing", "Miss",1)),
     B301_3 =ifelse(V3701=="(01) NEVER:(1)", 0, ifelse(V3701=="(99) 99:Missing", "Miss",1)),
     B301_4 =ifelse(V4701=="(01) NEVER:(1)", 0, ifelse(V4701=="(99) 99:Missing", "Miss",1)),
     B301_5 =ifelse(V5701=="(01) NEVER:(1)", 0, ifelse(V5701=="(99) 99:Missing", "Miss",1)),
     B301_6 =ifelse(V6701=="(01) NEVER:(1)", 0, ifelse(V6701=="(99) 99:Missing", "Miss",1)),
     B302_0 =ifelse(V302=="(01) NONE:(1)", 0, ifelse(V302=="(99) 99:Missing", "Miss",1)),
     B302_1 =ifelse(V1702=="(01) NT DAILY:(1)", 0, ifelse(V1702=="(99) 99:Missing", "Miss",1)),
     B302_2 =ifelse(V2702=="(01) NT DAILY:(1)", 0, ifelse(V2702=="(99) 99:Missing", "Miss",1)),
     B302_3 =ifelse(V3702=="(01) NT DAILY:(1)", 0, ifelse(V3702=="(99) 99:Missing", "Miss",1)),
     B302_4 =ifelse(V4702=="(01) NT DAILY:(1)", 0, ifelse(V4702=="(99) 99:Missing", "Miss",1)),
     B302_5 =ifelse(V5702=="(01) NT DAILY:(1)", 0, ifelse(V5702=="(99) 99:Missing", "Miss",1)),
     B302_6 =ifelse(V6702=="(01) NT DAILY:(1)", 0, ifelse(V6702=="(99) 99:Missing", "Miss",1))   
  )


#drinking
data = data %>%
  mutate(
         B304_0 =ifelse(V304=="(01) 0 OCCAS:(1)", 0, ifelse(V304=="(99) 99:Missing", "Miss",1)),
     B304_1 =ifelse(V1704=="(01) 0 OCCAS:(1)", 0, ifelse(V1704=="(99) 99:Missing", "Miss",1)),
     B304_2 =ifelse(V2704=="(01) 0 OCCAS:(1)", 0, ifelse(V2704=="(99) 99:Missing", "Miss",1)),
     B304_3 =ifelse(V3704=="(01) 0 OCCAS:(1)", 0, ifelse(V3704=="(99) 99:Missing", "Miss",1)),
     B304_4 =ifelse(V4704=="(01) 0 OCCAS:(1)", 0, ifelse(V4704=="(99) 99:Missing", "Miss",1)),
     B304_5 =ifelse(V5704=="(01) 0 OCCAS:(1)", 0, ifelse(V5704=="(99) 99:Missing", "Miss",1)),
     B304_6 =ifelse(V6704=="(01) 0 OCCAS:(1)", 0, ifelse(V6704=="(99) 99:Missing", "Miss",1)),
      B305_0 =ifelse(V305=="(01) 0 OCCAS:(1)", 0, ifelse(V305=="(99) 99:Missing", "Miss",1)),
     B305_1 =ifelse(V1705=="(01) 0 OCCAS:(1)", 0, ifelse(V1705=="(99) 99:Missing", "Miss",1)),
     B305_2 =ifelse(V2705=="(01) 0 OCCAS:(1)", 0, ifelse(V2705=="(99) 99:Missing", "Miss",1)),
     B305_3 =ifelse(V3705=="(01) 0 OCCAS:(1)", 0, ifelse(V3705=="(99) 99:Missing", "Miss",1)),
     B305_4 =ifelse(V4705=="(01) 0 OCCAS:(1)", 0, ifelse(V4705=="(99) 99:Missing", "Miss",1)),
     B305_5 =ifelse(V5705=="(01) 0 OCCAS:(1)", 0, ifelse(V5705=="(99) 99:Missing", "Miss",1)),
     B305_6 =ifelse(V6705=="(01) 0 OCCAS:(1)", 0, ifelse(V6705=="(99) 99:Missing", "Miss",1)),
      B306_0 =ifelse(V306=="(01) 0 OCCAS:(1)", 0, ifelse(V306=="(99) 99:Missing", "Miss",1)),
     B306_1 =ifelse(V1706=="(01) 0 OCCAS:(1)", 0, ifelse(V1706=="(99) 99:Missing", "Miss",1)),
     B306_2 =ifelse(V2706=="(01) 0 OCCAS:(1)", 0, ifelse(V2706=="(99) 99:Missing", "Miss",1)),
     B306_3 =ifelse(V3706=="(01) 0 OCCAS:(1)", 0, ifelse(V3706=="(99) 99:Missing", "Miss",1)),
     B306_4 =ifelse(V4706=="(01) 0 OCCAS:(1)", 0, ifelse(V4706=="(99) 99:Missing", "Miss",1)),
     B306_5 =ifelse(V5706=="(01) 0 OCCAS:(1)", 0, ifelse(V5706=="(99) 99:Missing", "Miss",1)),
     B306_6 =ifelse(V6706=="(01) 0 OCCAS:(1)", 0, ifelse(V6706=="(99) 99:Missing", "Miss",1))
  )
#MU

data = data %>%
  mutate(
         B315_0 =ifelse(V315=="(01) 0 OCCAS:(1)", 0, ifelse(V315=="(99) 99:Missing", "Miss",1)),
     B315_1 =ifelse(V1715=="(01) 0 OCCAS:(1)", 0, ifelse(V1715=="(99) 99:Missing", "Miss",1)),
     B315_2 =ifelse(V2715=="(01) 0 OCCAS:(1)", 0, ifelse(V2715=="(99) 99:Missing", "Miss",1)),
     B315_3 =ifelse(V3715=="(01) 0 OCCAS:(1)", 0, ifelse(V3715=="(99) 99:Missing", "Miss",1)),
     B315_4 =ifelse(V4715=="(01) 0 OCCAS:(1)", 0, ifelse(V4715=="(99) 99:Missing", "Miss",1)),
     B315_5 =ifelse(V5715=="(01) 0 OCCAS:(1)", 0, ifelse(V5715=="(99) 99:Missing", "Miss",1)),
     B315_6 =ifelse(V6715=="(01) 0 OCCAS:(1)", 0, ifelse(V6715=="(99) 99:Missing", "Miss",1)),
      B316_0 =ifelse(V316=="(01) 0 OCCAS:(1)", 0, ifelse(V316=="(99) 99:Missing", "Miss",1)),
     B316_1 =ifelse(V1716=="(01) 0 OCCAS:(1)", 0, ifelse(V1716=="(99) 99:Missing", "Miss",1)),
     B316_2 =ifelse(V2716=="(01) 0 OCCAS:(1)", 0, ifelse(V2716=="(99) 99:Missing", "Miss",1)),
     B316_3 =ifelse(V3716=="(01) 0 OCCAS:(1)", 0, ifelse(V3716=="(99) 99:Missing", "Miss",1)),
     B316_4 =ifelse(V4716=="(01) 0 OCCAS:(1)", 0, ifelse(V4716=="(99) 99:Missing", "Miss",1)),
     B316_5 =ifelse(V5716=="(01) 0 OCCAS:(1)", 0, ifelse(V5716=="(99) 99:Missing", "Miss",1)),
     B316_6 =ifelse(V6716=="(01) 0 OCCAS:(1)", 0, ifelse(V6716=="(99) 99:Missing", "Miss",1)),
      B317_0 =ifelse(V317=="(01) 0 OCCAS:(1)", 0, ifelse(V317=="(99) 99:Missing", "Miss",1)),
     B317_1 =ifelse(V1717=="(01) 0 OCCAS:(1)", 0, ifelse(V1717=="(99) 99:Missing", "Miss",1)),
     B317_2 =ifelse(V2717=="(01) 0 OCCAS:(1)", 0, ifelse(V2717=="(99) 99:Missing", "Miss",1)),
     B317_3 =ifelse(V3717=="(01) 0 OCCAS:(1)", 0, ifelse(V3717=="(99) 99:Missing", "Miss",1)),
     B317_4 =ifelse(V4717=="(01) 0 OCCAS:(1)", 0, ifelse(V4717=="(99) 99:Missing", "Miss",1)),
     B317_5 =ifelse(V5717=="(01) 0 OCCAS:(1)", 0, ifelse(V5717=="(99) 99:Missing", "Miss",1)),
     B317_6 =ifelse(V6717=="(01) 0 OCCAS:(1)", 0, ifelse(V6717=="(99) 99:Missing", "Miss",1))
  )

#LSD
data = data %>%
  mutate(
         B318_0 =ifelse(V318=="(01) 0 OCCAS:(1)", 0, ifelse(V318=="(99) 99:Missing", "Miss",1)),
     B318_1 =ifelse(V1718=="(01) 0 OCCAS:(1)", 0, ifelse(V1718=="(99) 99:Missing", "Miss",1)),
     B318_2 =ifelse(V2718=="(01) 0 OCCAS:(1)", 0, ifelse(V2718=="(99) 99:Missing", "Miss",1)),
     B318_3 =ifelse(V3718=="(01) 0 OCCAS:(1)", 0, ifelse(V3718=="(99) 99:Missing", "Miss",1)),
     B318_4 =ifelse(V4718=="(01) 0 OCCAS:(1)", 0, ifelse(V4718=="(99) 99:Missing", "Miss",1)),
     B318_5 =ifelse(V5718=="(01) 0 OCCAS:(1)", 0, ifelse(V5718=="(99) 99:Missing", "Miss",1)),
     B318_6 =ifelse(V6718=="(01) 0 OCCAS:(1)", 0, ifelse(V6718=="(99) 99:Missing", "Miss",1)),
      B319_0 =ifelse(V319=="(01) 0 OCCAS:(1)", 0, ifelse(V319=="(99) 99:Missing", "Miss",1)),
     B319_1 =ifelse(V1719=="(01) 0 OCCAS:(1)", 0, ifelse(V1719=="(99) 99:Missing", "Miss",1)),
     B319_2 =ifelse(V2719=="(01) 0 OCCAS:(1)", 0, ifelse(V2719=="(99) 99:Missing", "Miss",1)),
     B319_3 =ifelse(V3719=="(01) 0 OCCAS:(1)", 0, ifelse(V3719=="(99) 99:Missing", "Miss",1)),
     B319_4 =ifelse(V4719=="(01) 0 OCCAS:(1)", 0, ifelse(V4719=="(99) 99:Missing", "Miss",1)),
     B319_5 =ifelse(V5719=="(01) 0 OCCAS:(1)", 0, ifelse(V5719=="(99) 99:Missing", "Miss",1)),
     B319_6 =ifelse(V6719=="(01) 0 OCCAS:(1)", 0, ifelse(V6719=="(99) 99:Missing", "Miss",1)),
      B320_0 =ifelse(V320=="(01) 0 OCCAS:(1)", 0, ifelse(V320=="(99) 99:Missing", "Miss",1)),
     B320_1 =ifelse(V1720=="(01) 0 OCCAS:(1)", 0, ifelse(V1720=="(99) 99:Missing", "Miss",1)),
     B320_2 =ifelse(V2720=="(01) 0 OCCAS:(1)", 0, ifelse(V2720=="(99) 99:Missing", "Miss",1)),
     B320_3 =ifelse(V3720=="(01) 0 OCCAS:(1)", 0, ifelse(V3720=="(99) 99:Missing", "Miss",1)),
     B320_4 =ifelse(V4720=="(01) 0 OCCAS:(1)", 0, ifelse(V4720=="(99) 99:Missing", "Miss",1)),
     B320_5 =ifelse(V5720=="(01) 0 OCCAS:(1)", 0, ifelse(V5720=="(99) 99:Missing", "Miss",1)),
     B320_6 =ifelse(V6720=="(01) 0 OCCAS:(1)", 0, ifelse(V6720=="(99) 99:Missing", "Miss",1))
  )

#1:5 314
for (i in 1:3){
  for (j in 1:3){
      data[,paste0("B",320+3*(i-1)+j,"_",0)]=ifelse(data[,paste0("V",320+3*(i-1)+j)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",320+3*(i-1)+j)]=="(99) 99:Missing", "Miss",1))
    for (k in 1:6){
  data[,paste0("B",320+3*(i-1)+j,"_",k)]=ifelse(data[,paste0("V",1720+1000*(k-1)+3*(i-1)+j)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",1720+1000*(k-1)+3*(i-1)+j)]=="(99) 99:Missing", "Miss",1))
}
  }
}

for (i in 1:4){
  for (j in 1:3){
  data[,paste0("B",332+3*(i-1)+j,"_",0)]=ifelse(data[,paste0("V",332+3*(i-1)+j)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",332+3*(i-1)+j)]=="(99) 99:Missing", "Miss",1))
  for (k in 1:6){
      data[,paste0("B",332+3*(i-1)+j,"_",k)]=ifelse(data[,paste0("V",1732+1000*(k-1)+3*(i-1)+j)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",1732+1000*(k-1)+3*(i-1)+j)]=="(99) 99:Missing", "Miss",1))
  }
}
}

#318 321 324 327 333 336 339 342
for (i in 1:4){
  data[, paste0("O",317+ 3*(i-1)+1,"_",0)] = ifelse(data[,paste0("V",317+ 3*(i-1)+1)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",317+ 3*(i-1)+1)]=="(02) 1-2X:(2)", 1, ifelse(data[,paste0("V",317+ 3*(i-1)+1)] %in% c("(03) 3-5X:(3)", "(04) 6-9X:(4)"), 2,ifelse(data[,paste0("V",317+ 3*(i-1)+1)] %in% c("(05) 10-19X:(5)","(06) 20-39X:(6)","(07) 40+OCCAS:(7)"),3,"Miss"))))
  for (k in 1:6){
      data[, paste0("O",317+ 3*(i-1)+1,"_",k)] = ifelse(data[,paste0("V",1717+1000*(k-1)+ 3*(i-1)+1)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",1717+1000*(k-1)+ 3*(i-1)+1)]=="(02) 1-2X:(2)", 1, ifelse(data[,paste0("V",1717+1000*(k-1)+ 3*(i-1)+1)] %in% c("(03) 3-5X:(3)", "(04) 6-9X:(4)"), 2,ifelse(data[,paste0("V",1717+1000*(k-1)+ 3*(i-1)+1)] %in% c("(05) 10-19X:(5)","(06) 20-39X:(6)","(07) 40+OCCAS:(7)"),3,"Miss"))))
    
  }
}

for (i in 1:4){
  data[, paste0("O",332+ 3*(i-1)+1,"_",0)] = ifelse(data[,paste0("V",332+ 3*(i-1)+1)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",332+ 3*(i-1)+1)]=="(02) 1-2X:(2)", 1, ifelse(data[,paste0("V",332+ 3*(i-1)+1)] %in% c("(03) 3-5X:(3)", "(04) 6-9X:(4)"), 2,ifelse(data[,paste0("V",332+ 3*(i-1)+1)] %in% c("(05) 10-19X:(5)","(06) 20-39X:(6)","(07) 40+OCCAS:(7)"),3,"Miss"))))
  for (k in 1:6){
      data[, paste0("O",332+ 3*(i-1)+1,"_",k)] = ifelse(data[,paste0("V",1732+1000*(k-1)+ 3*(i-1)+1)]=="(01) 0 OCCAS:(1)", 0, ifelse(data[,paste0("V",1732+1000*(k-1)+ 3*(i-1)+1)]=="(02) 1-2X:(2)", 1, ifelse(data[,paste0("V",1732+1000*(k-1)+ 3*(i-1)+1)] %in% c("(03) 3-5X:(3)", "(04) 6-9X:(4)"), 2,ifelse(data[,paste0("V",1732+1000*(k-1)+ 3*(i-1)+1)] %in% c("(05) 10-19X:(5)","(06) 20-39X:(6)","(07) 40+OCCAS:(7)"),3,"Miss"))))
    
  }
}


vnames=c("coll", "marry", "binge", "B302","B306", "B316","B319", "B322", "B325", "B328", "B334","B337", "B340", "B343")

summary(apply(data[, paste0(vnames, "_0")]== "Miss", 2, mean),
apply(data[, paste0(vnames, "_1")]== "Miss", 2, na.rm=T,mean),
apply(data[, paste0(vnames, "_2")]== "Miss", 2, na.rm=T,mean),
apply(data[, paste0(vnames, "_3")]== "Miss", 2, na.rm=T,mean),
apply(data[, paste0(vnames, "_4")]== "Miss", 2, na.rm=T,mean),
apply(data[, paste0(vnames, "_5")]== "Miss", 2, na.rm=T,mean),
apply(data[, paste0(vnames, "_6")]== "Miss", 2, na.rm=T,mean))

apply(data[, paste0(vnames, "_0")]== "Miss", 2, mean)[3]
apply(data[, paste0(vnames, "_1")]== "Miss", 2, na.rm=T,mean)
apply(data[, paste0(vnames, "_2")]== "Miss", 2, na.rm=T,mean)
apply(data[, paste0(vnames, "_3")]== "Miss", 2, na.rm=T,mean)
apply(data[, paste0(vnames, "_4")]== "Miss", 2, na.rm=T,mean)
apply(data[, paste0(vnames, "_5")]== "Miss", 2, na.rm=T,mean)
apply(data[, paste0(vnames, "_6")]== "Miss", 2, na.rm=T,mean)


for (v in c(paste0(vnames,"_0"),paste0(vnames,"_1"),paste0(vnames,"_2"),paste0(vnames,"_3"),paste0(vnames,"_4"),paste0(vnames,"_5"),paste0(vnames,"_6"))) {
  
data[ !(is.na(data[,v])) & data[,v]=="Miss",v] = sample(c(0,1), sum(data[,v]=="Miss",na.rm = T), replace = TRUE, prob=table(data[!data[,v]=="Miss",v]))

}

data = data %>%
  mutate(
    comp_nm_0 = as.factor(ifelse(B328_0==0 & B334_0==0 & B337_0==0  & B343_0==0, 0, 1)),
    comp_2_0 = as.factor(ifelse(B319_0==0 & B322_0==0 & B325_0==0 & B340_0==0, 0, 1)),
        comp_nm_1 = as.factor(ifelse(B328_1==0 & B334_1==0 & B337_1==0  & B343_1==0, 0, 1)),
    comp_2_1 = as.factor(ifelse(B319_1==0 & B322_1==0 & B325_1==0 & B340_1==0, 0, 1)),
        comp_nm_2 = as.factor(ifelse(B328_2==0 & B334_2==0 & B337_2==0  & B343_2==0, 0, 1)),
    comp_2_2 = as.factor(ifelse(B319_2==0 & B322_2==0 & B325_2==0 & B340_2==0, 0, 1)),
        comp_nm_3 = as.factor(ifelse(B328_3==0 & B334_3==0 & B337_3==0  & B343_3==0, 0, 1)),
    comp_2_3 = as.factor(ifelse(B319_3==0 & B322_3==0 & B325_3==0 & B340_3==0, 0, 1)),
        comp_nm_4 = as.factor(ifelse(B328_4==0 & B334_4==0 & B337_4==0  & B343_4==0, 0, 1)),
    comp_2_4 = as.factor(ifelse(B319_4==0 & B322_4==0 & B325_4==0 & B340_4==0, 0, 1)),
        comp_nm_5 = as.factor(ifelse(B328_5==0 & B334_5==0 & B337_5==0  & B343_5==0, 0, 1)),
    comp_2_5 = as.factor(ifelse(B319_5==0 & B322_5==0 & B325_5==0 & B340_5==0, 0, 1)),
        comp_nm_6 = as.factor(ifelse(B328_6==0 & B334_6==0 & B337_6==0  & B343_6==0, 0, 1)),
    comp_2_6 = as.factor(ifelse(B319_6==0 & B322_6==0 & B325_6==0 & B340_6==0, 0, 1))
  )


```

##Attriton adjustment

```{r attrition, echo=FALSE, warning=FALSE, message=FALSE}

table(data$V101[(!is.na(data$V1001)) & (!is.na(data$V2001))  & (!is.na(data$V3001)) & (!is.na(data$V4001)) & (!is.na(data$V5001))  & (!is.na(data$V6001))])

table(data$V101[data$V101>2001],data$V6001[data$V101>2001], useNA = "always")

panel.ind=data.frame(subset(data[data$V101 %in% c(2002, 2003, 2004, 2005),],select = c("MTFID","V101","V1001", "V2001","V3001", "V4001","V5001", "V6001")))

panel.ind_l=reshape(panel.ind, direction="long",varying=c("V101","V1001", "V2001","V3001", "V4001","V5001", "V6001"),timevar="panel",times = 0:6, v.names="Res",idvar="MTFID")

panel.ind$cc_ind = ifelse((!is.na(panel.ind$V1001)) & (!is.na(panel.ind$V2001))  & (!is.na(panel.ind$V3001)) & (!is.na(panel.ind$V4001)) & (!is.na(panel.ind$V5001))  & (!is.na(panel.ind$V6001)),1,0)


table(panel.ind$cc_ind, panel.ind$V101)
length(unique(panel.ind$MTFID[panel.ind$cc_ind==1]))
length(unique(panel.ind$MTFID[panel.ind$cc_ind==1 & panel.ind$V101==2002]))
length(unique(panel.ind$MTFID[panel.ind$cc_ind==1 & panel.ind$V101==2003]))
length(unique(panel.ind$MTFID[panel.ind$cc_ind==1 & panel.ind$V101==2004]))
length(unique(panel.ind$MTFID[panel.ind$cc_ind==1 & panel.ind$V101==2005]))

# c(dim(data_d)[1], sum(data_d$cc_ind==1), sum(data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)])), sum(!is.na(data_d$V1001)),                                                       sum(!is.na(data_d$V2001)),sum(!is.na(data_d$V3001)),sum(!is.na(data_d$V4001)),sum(!is.na(data_d$V5001)),sum(!is.na(data_d$V6001)))

#sum(!is.na(panel.ind_l$Res))

fu_l=reshape(panel.ind, direction="long",varying=c("V1001", "V2001","V3001", "V4001","V5001", "V6001"),timevar="panel",times = 1:6, v.names="Res",idvar="MTFID")

cat("Number of available cases")
sum(!is.na(fu_l$Res))

length(unique(fu_l$MTFID[!is.na(fu_l$Res)]))
# for (j in 2:7){
#    panel.ind[,j] = factor(panel.ind[,j])
#  }
# 
#  panel.ind=panel.ind[order(panel.ind$V1001,panel.ind$V2001,panel.ind$V3001,panel.ind$V4001,panel.ind$V5001,panel.ind$V6001),]
# 
# 
# x=panel.ind$MTFID
# y=names(panel.ind)[-1]
# att_pt = expand.grid(X=x, Y=y)
# att_pt$X = factor(att_pt$X)
# att_pt$z = as.factor(as.vector(as.matrix(panel.ind[,-1])))
#  
# ggplot(data=att_pt, aes(X, Y, fill=z))+
#    geom_tile()+
#    scale_x_discrete("ID", breaks=NULL)+
#    #scale_fill_manual(values = c("NA"="white", "0"="black","1"="red"))+
#    coord_flip()

cat("Proportion of attrition")
apply(is.na(panel.ind[,-1]),2,mean)
cat("Number of available cases")
apply(!is.na(panel.ind[,-1]),2,sum)


#2002-5
data_v = subset(data,V101 %in% c(2002,2003, 2004, 2005), select=c(MTFID, ACLUST2, V105, V101,V1001, V2001,V3001, V4001,V5001, V6001,ASTRAT, V106, V139, V115, V34, V350, V351_rc, V353, V155, V363, V364, V383, V379, V365, V366, V367, V368, V369, V370, V372, V375, V376, V377, V379, V380, V381, V382, V383, V384, V391, V392, V393, V394, V395, V396, V397, V398, V399, V400, V401, V402, V403, V404, V302, V304, V308, V315, V318, V321, V324, V327, V333, V336, V339, V342))

data_v$V101=as.factor(data_v$V101)
data_v$V106=as.factor(data_v$V106)
data_v$ASTRAT=as.factor(data_v$ASTRAT)

data_v$cc_ind = ifelse((!is.na(data_v$V1001)) & (!is.na(data_v$V2001))  & (!is.na(data_v$V3001)) & (!is.na(data_v$V4001)) & (!is.na(data_v$V5001))  & (!is.na(data_v$V6001)),1,0)

# c("V101", "ASTRAT", "V106", "V115", "V34", "V350", "V351_rc", "V353", "V155", "V363", "V364", "V383", "V379", "V365", "V366", "V367", "V368", "V369", "V370", "V372", "V375", "V376", "V377", "V379", "V380", "V381", "V382", "V383", "V384", "V391", "V392", "V393", "V394", "V395", "V396", "V397", "V398", "V399", "V400", "V401", "V402", "V403", "V404", 
#               "V302", "V304", "V308", "V315", "V318", "V321", "V324", "V327", "V333", "V336", "V339", "V34")[! c("V101", "ASTRAT", "V106", "V115", "V34", "V350", "V351_rc", "V353", "V155", "V363", "V364", "V383", "V379", "V365", "V366", "V367", "V368", "V369", "V370", "V372", "V375", "V376", "V377", "V379", "V380", "V381", "V382", "V383", "V384", "V391", "V392", "V393", "V394", "V395", "V396", "V397", "V398", "V399", "V400", "V401", "V402", "V403", "V404", 
#               "V302", "V304", "V308", "V315", "V318", "V321", "V324", "V327", "V333", "V336", "V339", "V34") %in% names(data_v)]


attr_tr_cv = rpart(cc_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 +V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v, method = "class",control = rpart.control(cp=0.004,xval=10))



attr_tr = rpart(cc_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v, method = "class",control = rpart.control(cp=0.0005))


sapply(subset(data_v, select=c("V101", "ASTRAT", "V106", "V115", "V34", "V350", "V351_rc", "V353", "V155", "V363", "V364", "V383", "V379", "V365", "V366", "V367", "V368", "V369", "V370", "V372", "V375", "V376", "V377", "V379", "V380", "V381", "V382", "V383", "V384", "V391", "V392", "V393", "V394", "V395", "V396", "V397", "V398", "V399", "V400", "V401", "V402", "V403", "V404", 
              "V302", "V304", "V308", "V315", "V318", "V321", "V324", "V327", "V333", "V336", "V339", "V34")),class)



attr_ct = ctree(cc_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v,controls =  ctree_control(maxsurrogate = 2))

plot(data_v$cc_ind ~ as.factor(where(attr_ct)))

attr_logit_0 = glm(cc_ind ~ 1, data=data_v, family = "binomial")

attr_logit_f = glm(cc_ind ~ V101 + ASTRAT  +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v, family = "binomial")

attr_logit = stepAIC(attr_logit_0, scope = list(lower=attr_logit_0, upper=attr_logit_f),direction="forward", trace=TRUE)

summary(attr_logit)

#summary(attr_tr)
printcp(attr_tr)
#plotcp(attr_tr)
#plot(attr_tr)
#text(attr_tr)

#summary(attr_tr_cv)
printcp(attr_tr_cv)
#plotcp(attr_tr_cv)
png(filename = "I:/WorkingProgramFiles/plot/0706/cctree.png")
plot(attr_tr_cv, uniform=TRUE, compress=TRUE, main="Classification tree for CC indicators")
text(attr_tr_cv, use.n = TRUE, cex=0.6)
dev.off()

png(filename = "I:/WorkingProgramFiles/plot/0706/cc-ctree.png")
plot(attr_ct, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, id=FALSE),
     gp=gpar(fontsize=6),main="Classification tree for CC indicators")
#plot(attr_ct, 
#     gp=gpar(fontsize=6),main="Classification tree for CC indicators")
# ggparty(attr_ct) + geom_edge() + geom_edge_label() +
#   geom_node_splitvar()+
#   geom_node_info()
dev.off()


attr_p_tr =predict(attr_tr)[,2]
attr_p_tr_cv =predict(attr_tr_cv)[,2]

attr_p_lg =predict(attr_logit, type="response")

attr_p_ct = Predict(attr_ct)

hist(attr_p_lg, breaks=seq(0,1,by=0.1))
hist(attr_p_tr)
hist(attr_p_tr_cv)
hist(attr_p_ct)
hist(attr_p_lg[data_v$cc_ind==1])
hist(attr_p_tr[data_v$cc_ind==1])
hist(attr_p_tr_cv[data_v$cc_ind==1])

table(data_v$V379[attr_p_ct>0.6],data_v$cc_ind[attr_p_ct>0.6])

summary(attr_p_lg[data_v$cc_ind==1])
summary(attr_p_ct[data_v$cc_ind==1])
summary(1/attr_p_tr_cv[data_v$cc_ind==1])

roc(data_v$cc_ind ~ attr_p_lg, plot=TRUE, print.auc=TRUE)
roc(data_v$cc_ind ~ attr_p_tr, plot=TRUE, print.auc=TRUE)
roc(data_v$cc_ind ~ attr_p_tr_cv, plot=TRUE, print.auc=TRUE)
roc(data_v$cc_ind ~ attr_p_ct, plot=TRUE, print.auc=TRUE)

 table(data_v$V379[attr_p_ct<0.1 & data_v$cc_ind==1])
 
data_v = data_v %>%
  mutate(
  wgt_cc0 = 1 /attr_p_ct
  )
hist(data_v$wgt_cc0[data_v$cc_ind==1])
summary(data_v$wgt_cc0[data_v$cc_ind==1])
sd(data_v$wgt_cc0[data_v$cc_ind==1])
quantile((data_v$wgt_cc0[data_v$cc_ind==1]), probs = c(0.95))


data_v = data_v %>%
  mutate(
  wgt_cc = ifelse(wgt_cc0 > quantile(wgt_cc0[cc_ind==1], probs = c(0.95)),quantile(wgt_cc0[cc_ind==1], probs = c(0.95)), wgt_cc0  )
  )

hist(data_v$wgt_cc[data_v$cc_ind==1])
summary(data_v$wgt_cc[data_v$cc_ind==1])
sd(data_v$wgt_cc[data_v$cc_ind==1])

#wave 1 
data_v$fu1_ind = ifelse(is.na(data_v$V1001),0,1)

attr_fu1_tr = ctree(fu1_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

# attr_fu1_tr = rpart(fu1_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
#               V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
#               V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v, method = "class", control = rpart.control(cp=0.004, xval = 10))
#print(attr_fu1)
#plotcp(attr_fu1_tr)
#printcp(attr_fu1_tr)
plot(attr_fu1_tr)
#text(attr_fu1_tr)


attr_fu1 =predict(attr_fu1_tr)

attr_fu1_lg_0 = glm(fu1_ind ~ 1, data=data_v, family="binomial")
attr_fu1_lg_f = glm(fu1_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v, family="binomial")

attr_fu1_lg = stepAIC(attr_fu1_lg_0, scope = list(lower=attr_fu1_lg_0, upper=attr_fu1_lg_f),direction="forward", trace=TRUE)

summary(attr_fu1_lg)


attr_fu1_lg_s = glm(fu1_ind ~  V302*V155 + V315*V381 + V350*V393+ V350*V155 + V393*V155 + V155*V379 + V379*V350 + V381*V350,  data=data_v, family="binomial")

summary(attr_fu1_lg_s)

attr_fu1p_lg =predict(attr_fu1_lg, type="response")
attr_fu1p_lg_s =predict(attr_fu1_lg_s, type="response")
hist(attr_fu1)
hist(attr_fu1[data_v$fu1_ind==1])
hist(attr_fu1p_lg_s)

roc(data_v$fu1_ind ~ attr_fu1p_lg_s, plot=TRUE, print.auc=TRUE)
roc(data_v$fu1_ind ~ attr_fu1p_lg, plot=TRUE, print.auc=TRUE)
roc(data_v$fu1_ind ~ attr_fu1, plot=TRUE, print.auc=TRUE)


#wave 2 
data_v$fu2_ind = ifelse(is.na(data_v$V2001),0,1)

attr_fu2_tr = ctree(fu2_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

#printcp(attr_fu2_tr)
#plotcp(attr_fu2_tr)
plot(attr_fu2_tr)
#text(attr_fu2_tr)

attr_fu2 =predict(attr_fu2_tr)

hist(attr_fu2)
hist(attr_fu2[data_v$fu2_ind==1])

roc(data_v$fu2_ind ~ attr_fu2, plot=TRUE, print.auc=TRUE)

#wave 3 
data_v$fu3_ind = ifelse(is.na(data_v$V3001),0,1)

attr_fu3_tr = ctree(fu3_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

print(attr_fu3_tr)
#plotcp(attr_fu3_tr)
plot(attr_fu3_tr)
#text(attr_fu3_tr)

attr_fu3 =predict(attr_fu3_tr)

hist(attr_fu3)
hist(attr_fu3[data_v$fu3_ind==1])

roc(data_v$fu3_ind ~ attr_fu3, plot=TRUE, print.auc=TRUE)

#wave 4 
data_v$fu4_ind = ifelse(is.na(data_v$V4001),0,1)

attr_fu4_tr = ctree(fu4_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

print(attr_fu4_tr)
#plotcp(attr_fu4_tr)
plot(attr_fu4_tr)
#text(attr_fu4_tr)

attr_fu4 =predict(attr_fu4_tr)

hist(attr_fu4)
hist(attr_fu4[data_v$fu4_ind==1])

roc(data_v$fu4_ind ~ attr_fu4, plot=TRUE, print.auc=TRUE)

#wave 5 
data_v$fu5_ind = ifelse(is.na(data_v$V5001),0,1)

attr_fu5_tr = ctree(fu5_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

print(attr_fu5_tr)
#plotcp(attr_fu5_tr)
plot(attr_fu5_tr)
#text(attr_fu5_tr)

attr_fu5 =predict(attr_fu5_tr)

hist(attr_fu5)
hist(attr_fu5[data_v$fu5_ind==1])

roc(data_v$fu5_ind ~ attr_fu5, plot=TRUE, print.auc=TRUE)

#wave 6 
data_v$fu6_ind = ifelse(is.na(data_v$V6001),0,1)

attr_fu6_tr = ctree(fu6_ind ~ V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,  data=data_v)

print(attr_fu6_tr)
#plotcp(attr_fu6_tr)
plot(attr_fu6_tr)
#text(attr_fu6_tr)

attr_fu6 =predict(attr_fu6_tr)

hist(attr_fu6)
hist(attr_fu6[data_v$fu6_ind==1])

roc(data_v$fu6_ind ~ attr_fu6, plot=TRUE, print.auc=TRUE)

wgt_ac_data = data_v %>%
  mutate(
    wgt_ac0=1,
  wgt_ac1 = ifelse(fu1_ind==1, 1/attr_fu1, NA),
  wgt_ac2 = ifelse(fu2_ind==1, 1/attr_fu2, NA),
  wgt_ac3 = ifelse(fu3_ind==1, 1/attr_fu3, NA),
  wgt_ac4 = ifelse(fu4_ind==1, 1/attr_fu4, NA),
  wgt_ac5 = ifelse(fu5_ind==1, 1/attr_fu5, NA),
  wgt_ac6 = ifelse(fu6_ind==1, 1/attr_fu6, NA)
  )%>%
  mutate(
   wgt_ac1 = ifelse(wgt_ac1 > quantile(wgt_ac1, na.rm=T, probs = 0.95), quantile(wgt_ac1, na.rm=T, probs = 0.95),wgt_ac1),
      wgt_ac2 = ifelse(wgt_ac2 > quantile(wgt_ac2, na.rm=T, probs = 0.95), quantile(wgt_ac2, na.rm=T, probs = 0.95),wgt_ac2),
      wgt_ac3 = ifelse(wgt_ac3 > quantile(wgt_ac3, na.rm=T, probs = 0.95), quantile(wgt_ac3, na.rm=T, probs = 0.95),wgt_ac3),
      wgt_ac4 = ifelse(wgt_ac4 > quantile(wgt_ac4, na.rm=T, probs = 0.95), quantile(wgt_ac4, na.rm=T, probs = 0.95),wgt_ac4),
      wgt_ac5 = ifelse(wgt_ac5 > quantile(wgt_ac5, na.rm=T, probs = 0.95), quantile(wgt_ac5, na.rm=T, probs = 0.95),wgt_ac5),
      wgt_ac6 = ifelse(wgt_ac6 > quantile(wgt_ac6, na.rm=T, probs = 0.95), quantile(wgt_ac6, na.rm=T, probs = 0.95),wgt_ac6)
   
  )%>%
  dplyr::select(MTFID, wgt_ac0, wgt_ac1,wgt_ac2, wgt_ac3, wgt_ac4, wgt_ac5, wgt_ac6) 
  

apply(is.na(wgt_ac_data),2,sum)

summary(wgt_ac_data$wgt_ac1)
```


```{r results, echo=FALSE, warning=FALSE, message=FALSE}

c(as.numeric(auc(roc(data_v$cc_ind ~ attr_p_tr_cv, print.auc=TRUE))), 0,
    as.numeric(auc(roc(data_v$fu1_ind ~ attr_fu1, print.auc=TRUE))),
    as.numeric(auc(roc(data_v$fu2_ind ~ attr_fu2, print.auc=TRUE))),
    as.numeric(auc(roc(data_v$fu3_ind ~ attr_fu3, print.auc=TRUE))),
    as.numeric(auc(roc(data_v$fu4_ind ~ attr_fu4, print.auc=TRUE))),
    as.numeric(auc(roc(data_v$fu5_ind ~ attr_fu5, print.auc=TRUE))),
as.numeric(auc(roc(data_v$fu6_ind ~ attr_fu6, print.auc=TRUE))))


cat("cc wgt")
round(as.numeric(summary(data_v$wgt_cc[data_v$cc_ind==1])),1)


apply(round(wgt_ac_data[,-1],1),2,summary)
  
  #apply(wgt_ac_data[,-1],2,mean), apply(wgt_ac_data[,-1],2,sd), apply(wgt_ac_data[,-1],2,min), apply(wgt_ac_data[,-1],2,max))

png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree1.png")
#pdf(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree1.pdf")
#png(filename = "ac-ctree1.png")
plot(attr_fu1_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 1 [Age 19/20] -AC response indicators")
dev.off()

#ggparty(attr_fu1_tr) + geom_edge() + geom_edge_label()

png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree2.png")
plot(attr_fu2_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 2 [Age 21/22] -AC response indicators")
dev.off()


png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree3.png")
plot(attr_fu3_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 3 [Age 23/24] -AC response indicators")
dev.off()

png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree4.png")
plot(attr_fu4_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 4 [Age 25/26] -AC response indicators")
dev.off()

png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree5.png")
plot(attr_fu5_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 5 [Age 27/28] -AC response indicators")
dev.off()

png(filename = "I:/WorkingProgramFiles/plot/0706/ac-ctree6.png")
plot(attr_fu6_tr, type="simple", drop_terminal=TRUE, inner_panel=node_inner(attr_ct, pval = FALSE),
     edge_panel=edge_simple(attr_ct, abbreviate = TRUE), terminal_panel=node_terminal(attr_ct, abbreviate = TRUE, digits = 1, id=FALSE), main="Classification tree for Wave 6 [Age 29/30] -AC response indicators")
dev.off()

# png(filename = "I:/WorkingProgramFiles/plot/0706/actree2.png")
# plot(attr_fu2_tr, uniform=TRUE, compress=TRUE, main="Classification tree for Wave 2-AC indicators")
# text(attr_fu2_tr, use.n = TRUE, cex=0.6)
# dev.off()
# 
# png(filename = "I:/WorkingProgramFiles/plot/0706/actree3.png")
# plot(attr_fu3_tr, uniform=TRUE, compress=TRUE, main="Classification tree for Wave 3-AC indicators")
# text(attr_fu3_tr, use.n = TRUE, cex=0.6)
# dev.off()
# 
# png(filename = "I:/WorkingProgramFiles/plot/0706/actree4.png")
# plot(attr_fu4_tr, uniform=TRUE, compress=TRUE, main="Classification tree for Wave 4-AC indicators")
# text(attr_fu4_tr, use.n = TRUE, cex=0.6)
# dev.off()
# 
# png(filename = "I:/WorkingProgramFiles/plot/0706/actree5.png")
# plot(attr_fu5_tr, uniform=TRUE, compress=TRUE, main="Classification tree for Wave 5-AC indicators")
# text(attr_fu5_tr, use.n = TRUE, cex=0.6)
# dev.off()
# 
# png(filename = "I:/WorkingProgramFiles/plot/0706/actree6.png")
# plot(attr_fu6_tr, uniform=TRUE, compress=TRUE, main="Classification tree for Wave 6-AC indicators")
# text(attr_fu6_tr, use.n = TRUE, cex=0.6)
# dev.off()
```



#reshape from wide to long

```{r reshape, echo=FALSE, warning=FALSE, message=FALSE}
ynames=c("coll", "marry", "binge", "B302","B306", "B316","comp_nm", "comp_2", "B343")

# data_p =cbind(data_v, data[data$V101 %in% c(2002,2003, 2004,2005), c(paste0(ynames,"_", 0), paste0(ynames,"_", 1),
#                                                           paste0(ynames,"_", 2),paste0(ynames,"_", 3),
#                                                           paste0(ynames,"_",4), paste0(ynames,"_",5), paste0(ynames,"_",6))])
# 
# coll=cbind(data_v, data[data$V101 %in% c(2002,2003, 2004,2005), paste0("coll_", 0:6)])
# 
# data_l=reshape(coll, direction="long",varying=paste0("coll_", 0:6),timevar="panel",times = 0:6, v.names="coll",idvar="MTFID")
# 
# for (v in ynames[-1]){
#   temp_v=reshape(data[data$V101 %in% c(2002,2003, 2004,2005),c("MTFID", paste0(v, "_",0:6))], direction="long",varying=paste0(v, "_", 0:6),timevar="panel",times = 0:6, v.names=v,idvar="MTFID")
#   
#    data_l=merge(data_l, temp_v,by=c("MTFID","panel"))
# }

data_p =cbind(data_v, data[data$V101 %in% c(2002,2003, 2004,2005), c(paste0(ynames,"_", 0), paste0(ynames,"_", 1),
                                                          paste0(ynames,"_", 2),paste0(ynames,"_", 3),
                                                          paste0(ynames,"_",4), paste0(ynames,"_",5), paste0(ynames,"_",6))])

coll=cbind(data_v, data[data$V101 %in% c(2002,2003, 2004,2005), c(paste0(ynames,"_", 0), paste0("coll_", 1:6))])

data_l=reshape(coll, direction="long",varying=paste0("coll_", 1:6),timevar="panel",times = 1:6, v.names="coll",idvar="MTFID")

for (v in ynames[-1]){
  temp_v=reshape(data[data$V101 %in% c(2002,2003, 2004,2005),c("MTFID", paste0(v, "_", 1:6))], direction="long",varying=paste0(v, "_", 1:6),timevar="panel",times = 1:6, v.names=v,idvar="MTFID")
  
   data_l=merge(data_l, temp_v,by=c("MTFID","panel"))
}


#data_long=merge(data_l,coll_l,by=c("MTFID","panel"))
#data_long=merge(data_long,marry_l,by=c("MTFID","panel"))


# data_l = reshape(data_p, direction="long", varying= c(paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 0), paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 1),
#                                                           paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 2),paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 3),
#                                                           paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 4),paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 5),
#                                                           paste0(c("coll_", "marry_", "binge_", "B302_","B306_", "B316_","comp_nm_", "comp_2_", "B343_"), 6)),
#                  timevar="panel",times = 0:6, v.names=c("coll", "marry", "binge", "B302","B306", "B316","comp_nm", "comp_2", "B343"),idvar="MTFID")





wgt_ac_l=reshape(wgt_ac_data, direction="long",varying=paste0("wgt_ac", 1:6),timevar="panel",times = 1:6, v.names="wgt_ac",idvar="MTFID")

summary(wgt_ac_l$wgt_ac[wgt_ac_l$panel==1])



# table(data_p$binge_0,useNA = "always")
# table(data_l$binge[data_l$panel==0],useNA = "always")
# 
# table(data_p$binge_1,useNA = "always")
# table(data_p$binge_1[!is.na(data_p$V1001)],useNA = "always")
# table(data_l$binge[data_l$panel==1],useNA = "always")
# table(data_l$binge[(!is.na(data_l$V1001)) & data_l$panel==1],useNA = "always")

#data_long=merge(data_l,coll_l,by=c("MTFID","panel"))
#data_long=merge(data_long,marry_l,by=c("MTFID","panel"))
data_long=merge(data_l,wgt_ac_l,by=c("MTFID","panel"))


#data_long$binge[ !(is.na(data_long$binge)) & data_long$binge=="Miss"] = sample(c(0,1), sum(data_long$binge=="Miss",na.rm = T), replace = TRUE, prob=table(data_long$binge[!data_long$binge=="Miss"]))
#data_long$binge=as.numeric(as.character(data_long$binge))
vnames2=c("binge", "B302","B306", "B316","comp_nm", "comp_2", "B343")
for (v in vnames2) {
data_long[,v]=as.numeric(as.character(data_long[,v]))
}

data_long$coll = as.factor(data_long$coll)
data_long$marry = as.factor(data_long$marry)
data_long$panel=as.factor(data_long$panel)


data_long=droplevels(data_long)



```

# descriptive statistics
```{r describe, echo=FALSE, warning=FALSE,message=FALSE}

data_d=merge(data_p,wgt_ac_data,by=c("MTFID"))

cat("sample size")
c(dim(data_d)[1], sum(data_d$cc_ind==1), sum(data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)])), sum(!is.na(data_d$V1001)),                                                       sum(!is.na(data_d$V2001)),sum(!is.na(data_d$V3001)),sum(!is.na(data_d$V4001)),sum(!is.na(data_d$V5001)),sum(!is.na(data_d$V6001)))

x.list = c("V101", "V106", "V350", "V351_rc", "V363", "V364", "V379")

x.table = round(c(mean(data_d$V34), mean(data_d$V34[data_d$cc_ind==1]), mean(data_d$V34[data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)])]),mean(data_d$V34[!is.na(data_d$V1001)]),
 mean(data_d$V34[!is.na(data_d$V2001)]),mean(data_d$V34[!is.na(data_d$V3001)]),
 mean(data_d$V34[!is.na(data_d$V4001)]),mean(data_d$V34[!is.na(data_d$V5001)]),
 mean(data_d$V34[!is.na(data_d$V6001)])), 0)

x.table = rbind(x.table, round(c(sd(data_d$V34), sd(data_d$V34[data_d$cc_ind==1]), sd(data_d$V34[data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)])]),sd(data_d$V34[!is.na(data_d$V1001)]),
 sd(data_d$V34[!is.na(data_d$V2001)]), sd(data_d$V34[!is.na(data_d$V3001)]),
 sd(data_d$V34[!is.na(data_d$V4001)]),sd(data_d$V34[!is.na(data_d$V5001)]),
 sd(data_d$V34[!is.na(data_d$V6001)])), 0))

for (x in x.list){

x.table=rbind(x.table, round(cbind(as.numeric(table(data_d[, x])/sum(table(data_d[, x]))), as.numeric(table(data_d[data_d$cc_ind==1, x])/sum(table(data_d[data_d$cc_ind==1, x]))), as.numeric(table(data_d[data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)]), x])/sum(table(data_d[data_d$MTFID %in% unique(fu_l$MTFID[!is.na(fu_l$Res)]), x]))),
 as.numeric(table(data_d[!is.na(data_d$V1001), x])/sum(table(data_d[!is.na(data_d$V1001), x]))),    
  as.numeric(table(data_d[!is.na(data_d$V2001), x])/sum(table(data_d[!is.na(data_d$V2001), x]))), 
  as.numeric(table(data_d[!is.na(data_d$V3001), x])/sum(table(data_d[!is.na(data_d$V3001), x]))), 
  as.numeric(table(data_d[!is.na(data_d$V4001), x])/sum(table(data_d[!is.na(data_d$V4001), x]))), 
  as.numeric(table(data_d[!is.na(data_d$V5001), x])/sum(table(data_d[!is.na(data_d$V5001), x]))), 
  as.numeric(table(data_d[!is.na(data_d$V6001), x])/sum(table(data_d[!is.na(data_d$V6001), x])))), 2))
} 

#apply(x.table,1,sum)==0

kable(data.frame(cbind(c("Age.m", "AGE.sd", names(table(data_v$V101)),names(table(data_v$V106)), names(table(data_v$V350)),
names(table(data_v$V351_rc)), names(table(data_v$V363)), names(table(data_v$V364)),names(table(data_v$V379))), x.table[!(apply(x.table,1,sum)==0),])), row.names=NA, col.names = c("", "All", "CC", "AC", "19/20","21/22", "23/24","25/26", "27/28","29/30"))

# 
# kable(data.frame(cbind(c("Age.m", "AGE.sd", levels(data_v$V101), levels(data_v$V106), levels(data_v$V350),
# levels(data_v$V351_rc), levels(data_v$V363), levels(data_v$V364),levels(data_v$V379)), x.table)), col.names = c("", "All", "CC", "AC", "19/20","21/22", "23/24","25/26", "27/28","29/30"))

# bl.svy = svydesign(id= ~MTFID,  data = data_d)
# cc.svy = svydesign(id= ~ MTFID, weights= ~wgt_cc, data = subset(data_d,cc_ind==1))
# fu1.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac1, data = subset(data_d,fu1_ind==1))
# fu2.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac2, data = subset(data_d,fu2_ind==1))
# fu3.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac3, data = subset(data_d,fu3_ind==1))
# fu4.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac4, data = subset(data_d,fu4_ind==1))
# fu5.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac5, data = subset(data_d,fu5_ind==1))
# fu6.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac6, data = subset(data_d,fu6_ind==1))

bl.svy = svydesign(id= ~MTFID, data = data_d)
cc.svy = svydesign(id= ~ MTFID, weights= ~wgt_cc, data = subset(data_d,cc_ind==1))
fu1.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac1, data = subset(data_d,fu1_ind==1))
fu2.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac2, data = subset(data_d,fu2_ind==1))
fu3.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac3, data = subset(data_d,fu3_ind==1))
fu4.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac4, data = subset(data_d,fu4_ind==1))
fu5.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac5, data = subset(data_d,fu5_ind==1))
fu6.svy = svydesign(id= ~ MTFID, weights= ~wgt_ac6, data = subset(data_d,fu6_ind==1))


binge=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$binge_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$binge_0==1,na.rm=TRUE),mean(data_d$binge_1==1,na.rm=TRUE),mean(data_d$binge_2==1,na.rm=TRUE),mean(data_d$binge_3==1,na.rm=TRUE),mean(data_d$binge_4==1,na.rm=TRUE),mean(data_d$binge_5==1,na.rm=TRUE),mean(data_d$binge_6==1,na.rm=TRUE),
                svymean(~binge_0,cc.svy, na.rm=TRUE)[2],svymean(~binge_1,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_2,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_3,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_4,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_5,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~binge_0,bl.svy, na.rm=TRUE)[2],svymean(~binge_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~binge_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~binge_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~binge_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~binge_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~binge_6,fu6.svy, na.rm=TRUE)[2])))
  # c(as.numeric(SE(svymean(~binge_0,bl.svy, na.rm=TRUE)))[2],as.numeric(SE(svymean(~binge_1,fu1.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_2,fu2.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_3,fu3.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_4,fu4.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_5,fu5.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_6,fu6.svy, na.rm=TRUE)))[2])))

names(binge)=c("type","Panel", "est")

binge$est=as.numeric(as.character(binge$est))

binge_d=ggplot(data=binge,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Binge drinking", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


B302=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$B302_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B302_0==1,na.rm=TRUE),mean(data_d$B302_1==1,na.rm=TRUE),mean(data_d$B302_2==1,na.rm=TRUE),mean(data_d$B302_3==1,na.rm=TRUE),mean(data_d$B302_4==1,na.rm=TRUE),mean(data_d$B302_5==1,na.rm=TRUE),mean(data_d$B302_6==1,na.rm=TRUE),
                svymean(~B302_0,cc.svy, na.rm=TRUE)[2],svymean(~B302_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~B302_0,bl.svy, na.rm=TRUE)[2],svymean(~B302_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B302_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B302_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B302_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B302_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B302_6,fu6.svy, na.rm=TRUE)[2])))

names(B302)=c("type","Panel", "est")

B302$est=as.numeric(as.character(B302$est))

B302_d=ggplot(data=B302,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Cigarette smoking", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


B316=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$B316_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B316_0==1,na.rm=TRUE),mean(data_d$B316_1==1,na.rm=TRUE),mean(data_d$B316_2==1,na.rm=TRUE),mean(data_d$B316_3==1,na.rm=TRUE),mean(data_d$B316_4==1,na.rm=TRUE),mean(data_d$B316_5==1,na.rm=TRUE),mean(data_d$B316_6==1,na.rm=TRUE),
                svymean(~B316_0,cc.svy, na.rm=TRUE)[2],svymean(~B316_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~B316_0,bl.svy, na.rm=TRUE)[2],svymean(~B316_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B316_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B316_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B316_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B316_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B316_6,fu6.svy, na.rm=TRUE)[2])))

names(B316)=c("type","Panel", "est")

B316$est=as.numeric(as.character(B316$est))

B316_d=ggplot(data=B316,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Marijuana use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


comp_nm=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$comp_nm_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$comp_nm_0==1,na.rm=TRUE),mean(data_d$comp_nm_1==1,na.rm=TRUE),mean(data_d$comp_nm_2==1,na.rm=TRUE),mean(data_d$comp_nm_3==1,na.rm=TRUE),mean(data_d$comp_nm_4==1,na.rm=TRUE),mean(data_d$comp_nm_5==1,na.rm=TRUE),mean(data_d$comp_nm_6==1,na.rm=TRUE),
                svymean(~comp_nm_0,cc.svy, na.rm=TRUE)[2],svymean(~comp_nm_1,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_2,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_3,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_4,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_5,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~comp_nm_0,bl.svy, na.rm=TRUE)[2],svymean(~comp_nm_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_6,fu6.svy, na.rm=TRUE)[2])))

names(comp_nm)=c("type","Panel", "est")

comp_nm$est=as.numeric(as.character(comp_nm$est))

comp_nm_d=ggplot(data=comp_nm,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="NMPD use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


comp_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$comp_2_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$comp_2_0==1,na.rm=TRUE),mean(data_d$comp_2_1==1,na.rm=TRUE),mean(data_d$comp_2_2==1,na.rm=TRUE),mean(data_d$comp_2_3==1,na.rm=TRUE),mean(data_d$comp_2_4==1,na.rm=TRUE),mean(data_d$comp_2_5==1,na.rm=TRUE),mean(data_d$comp_2_6==1,na.rm=TRUE),
                svymean(~comp_2_0,cc.svy, na.rm=TRUE)[2],svymean(~comp_2_1,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_2,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_3,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_4,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_5,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~comp_2_0,bl.svy, na.rm=TRUE)[2],svymean(~comp_2_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~comp_2_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~comp_2_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~comp_2_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~comp_2_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~comp_2_6,fu6.svy, na.rm=TRUE)[2])))

names(comp_2)=c("type","Panel", "est")

comp_2$est=as.numeric(as.character(comp_2$est))

comp_2_d=ggplot(data=comp_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Illicit drug use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")

B343=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$B343_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B343_0==1,na.rm=TRUE),mean(data_d$B343_1==1,na.rm=TRUE),mean(data_d$B343_2==1,na.rm=TRUE),mean(data_d$B343_3==1,na.rm=TRUE),mean(data_d$B343_4==1,na.rm=TRUE),mean(data_d$B343_5==1,na.rm=TRUE),mean(data_d$B343_6==1,na.rm=TRUE),
                svymean(~B343_0,cc.svy, na.rm=TRUE)[2],svymean(~B343_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~B343_0,bl.svy, na.rm=TRUE)[2],svymean(~B343_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B343_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B343_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B343_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B343_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B343_6,fu6.svy, na.rm=TRUE)[2])))

names(B343)=c("type","Panel", "est")

B343$est=as.numeric(as.character(B343$est))

B343_d=ggplot(data=B343,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Opioid use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")
```


```{r dis-plot, include=FALSE, warning=FALSE, message=FALSE}

melegend = g_legend(binge_d)
ggsave(grid.arrange(arrangeGrob(binge_d + theme(axis.text.x = element_text(size = 7), legend.position = "none"), B302_d+theme(axis.text.x = element_text(size = 7), legend.position = "none"), B316_d + theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                                                  B343_d + theme(axis.text.x = element_text(size = 7), legend.position = "none"), 
                         comp_nm_d + theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                         comp_2_d + theme(axis.text.x = element_text(size =7), legend.position = "none"),
ncol = 2
                         ), bottom=melegend,ncol=1),
width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum.png")


ggsave(binge_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-binge.png")
ggsave(B302_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-b302.png")
ggsave(B316_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-b316.png")
ggsave(comp_nm_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-compnm.png")
ggsave(comp_2_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-comp2.png")
ggsave(B343_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-b343.png")


coll=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$coll_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_6[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$coll_1==1,na.rm=TRUE),mean(data_d$coll_2==1,na.rm=TRUE),mean(data_d$coll_3==1,na.rm=TRUE),mean(data_d$coll_4==1,na.rm=TRUE),mean(data_d$coll_5==1,na.rm=TRUE),mean(data_d$coll_6==1,na.rm=TRUE),
                svymean(~coll_1,cc.svy, na.rm=TRUE)[2],
                svymean(~coll_2,cc.svy, na.rm=TRUE)[2],
                svymean(~coll_3,cc.svy, na.rm=TRUE)[2],
                svymean(~coll_4,cc.svy, na.rm=TRUE)[2],
                svymean(~coll_5,cc.svy, na.rm=TRUE)[2],
                svymean(~coll_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~coll_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~coll_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~coll_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~coll_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~coll_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~coll_6,fu6.svy, na.rm=TRUE)[2])))

names(coll)=c("type","Panel", "est")

coll$est=as.numeric(as.character(coll$est))

coll_d=ggplot(data=coll,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="College attendance", y="proportion", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")

ggsave(coll_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-coll.png")

marry=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=7), rep(c("18", "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$marry_0[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$marry_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$marry_0==1,na.rm=TRUE),mean(data_d$marry_1==1,na.rm=TRUE),mean(data_d$marry_2==1,na.rm=TRUE),mean(data_d$marry_3==1,na.rm=TRUE),mean(data_d$marry_4==1,na.rm=TRUE),mean(data_d$marry_5==1,na.rm=TRUE),mean(data_d$marry_6==1,na.rm=TRUE),
                svymean(~marry_0,cc.svy, na.rm=TRUE)[2],svymean(~marry_1,cc.svy, na.rm=TRUE)[2],
                svymean(~marry_2,cc.svy, na.rm=TRUE)[2],
                svymean(~marry_3,cc.svy, na.rm=TRUE)[2],
                svymean(~marry_4,cc.svy, na.rm=TRUE)[2],
                svymean(~marry_5,cc.svy, na.rm=TRUE)[2],
                svymean(~marry_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~marry_0,bl.svy, na.rm=TRUE)[2],svymean(~marry_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~marry_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~marry_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~marry_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~marry_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~marry_6,fu6.svy, na.rm=TRUE)[2])))

names(marry)=c("type","Panel", "est")

marry$est=as.numeric(as.character(marry$est))

marry_d=ggplot(data=marry,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Married respondents", y="proportion", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")

ggsave(marry_d, width = 5, height = 3, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-marry.png")

```

```{r rm baseline, echo=FALSE, warning=FALSE, message=FALSE}


# binge_col=data.frame(cbind(rep(c("Coll","Non-coll"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),2),
                  c(sum((data_d$binge_1[data_d$cc_ind==1]==1) & (data_d$coll_1[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_1[data_d$cc_ind==1]==1),na.rm=TRUE),sum((data_d$binge_2[data_d$cc_ind==1]==1) & (data_d$coll_2[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_2[data_d$cc_ind==1]==1),na.rm=TRUE),sum((data_d$binge_3[data_d$cc_ind==1]==1) & (data_d$coll_3[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_3[data_d$cc_ind==1]==1),na.rm=TRUE),sum((data_d$binge_4[data_d$cc_ind==1]==1) & (data_d$coll_4[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_4[data_d$cc_ind==1]==1),na.rm=TRUE),sum((data_d$binge_5[data_d$cc_ind==1]==1) & (data_d$coll_5[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_5[data_d$cc_ind==1]==1),na.rm=TRUE),sum((data_d$binge_6[data_d$cc_ind==1]==1) & (data_d$coll_6[data_d$cc_ind==1]==1),na.rm=TRUE)/sum((data_d$coll_6[data_d$cc_ind==1]==1),na.rm=TRUE),
            sum((data_d$binge_1[data_d$cc_ind==1]==1) & (data_d$coll_1[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_1[data_d$cc_ind==1]==0),na.rm=TRUE),sum((data_d$binge_2[data_d$cc_ind==1]==1) & (data_d$coll_2[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_2[data_d$cc_ind==1]==0),na.rm=TRUE),sum((data_d$binge_3[data_d$cc_ind==1]==1) & (data_d$coll_3[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_3[data_d$cc_ind==1]==0),na.rm=TRUE),sum((data_d$binge_4[data_d$cc_ind==1]==1) & (data_d$coll_4[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_4[data_d$cc_ind==1]==0),na.rm=TRUE),sum((data_d$binge_5[data_d$cc_ind==1]==1) & (data_d$coll_5[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_5[data_d$cc_ind==1]==0),na.rm=TRUE),sum((data_d$binge_6[data_d$cc_ind==1]==1) & (data_d$coll_6[data_d$cc_ind==1]==0),na.rm=TRUE)/sum((data_d$coll_6[data_d$cc_ind==1]==0),na.rm=TRUE))
            
binge2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(
                    #mean(data_d$binge_0[data_d$cc_ind==1]==1,na.rm=TRUE),
                    mean(data_d$binge_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$binge_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            #mean(data_d$binge_0==1,na.rm=TRUE),
            mean(data_d$binge_1==1,na.rm=TRUE),mean(data_d$binge_2==1,na.rm=TRUE),mean(data_d$binge_3==1,na.rm=TRUE),mean(data_d$binge_4==1,na.rm=TRUE),mean(data_d$binge_5==1,na.rm=TRUE),mean(data_d$binge_6==1,na.rm=TRUE),
                #svymean(~binge_0,cc.svy, na.rm=TRUE)[2],
            svymean(~binge_1,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_2,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_3,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_4,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_5,cc.svy, na.rm=TRUE)[2],
                svymean(~binge_6,cc.svy, na.rm=TRUE)[2],     
            #svymean(~binge_0,bl.svy, na.rm=TRUE)[2],
            svymean(~binge_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~binge_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~binge_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~binge_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~binge_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~binge_6,fu6.svy, na.rm=TRUE)[2])))
  # c(as.numeric(SE(svymean(~binge_0,bl.svy, na.rm=TRUE)))[2],as.numeric(SE(svymean(~binge_1,fu1.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_2,fu2.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_3,fu3.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_4,fu4.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_5,fu5.svy, na.rm=TRUE)))[2],
  #               as.numeric(SE(svymean(~binge_6,fu6.svy, na.rm=TRUE)))[2])))

names(binge2)=c("type","Panel", "est")

binge2$est=as.numeric(as.character(binge2$est))

binge_d2=ggplot(data=binge2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Binge drinking", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


B302_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(
                    mean(data_d$B302_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B302_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B302_1==1,na.rm=TRUE),mean(data_d$B302_2==1,na.rm=TRUE),mean(data_d$B302_3==1,na.rm=TRUE),mean(data_d$B302_4==1,na.rm=TRUE),mean(data_d$B302_5==1,na.rm=TRUE),mean(data_d$B302_6==1,na.rm=TRUE),
                svymean(~B302_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B302_6,cc.svy, na.rm=TRUE)[2],     
           svymean(~B302_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B302_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B302_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B302_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B302_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B302_6,fu6.svy, na.rm=TRUE)[2])))

names(B302_2)=c("type","Panel", "est")

B302_2$est=as.numeric(as.character(B302_2$est))

B302_d2=ggplot(data=B302_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Cigarette smoking", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


B316_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$B316_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B316_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B316_1==1,na.rm=TRUE),mean(data_d$B316_2==1,na.rm=TRUE),mean(data_d$B316_3==1,na.rm=TRUE),mean(data_d$B316_4==1,na.rm=TRUE),mean(data_d$B316_5==1,na.rm=TRUE),mean(data_d$B316_6==1,na.rm=TRUE),
               svymean(~B316_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B316_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~B316_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B316_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B316_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B316_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B316_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B316_6,fu6.svy, na.rm=TRUE)[2])))

names(B316_2)=c("type","Panel", "est")

B316_2$est=as.numeric(as.character(B316_2$est))

B316_d2=ggplot(data=B316_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Marijuana use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


comp_nm_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$comp_nm_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_nm_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$comp_nm_1==1,na.rm=TRUE),mean(data_d$comp_nm_2==1,na.rm=TRUE),mean(data_d$comp_nm_3==1,na.rm=TRUE),mean(data_d$comp_nm_4==1,na.rm=TRUE),mean(data_d$comp_nm_5==1,na.rm=TRUE),mean(data_d$comp_nm_6==1,na.rm=TRUE),
                svymean(~comp_nm_1,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_2,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_3,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_4,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_5,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~comp_nm_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~comp_nm_6,fu6.svy, na.rm=TRUE)[2])))

names(comp_nm_2)=c("type","Panel", "est")

comp_nm_2$est=as.numeric(as.character(comp_nm_2$est))

comp_nm_d2=ggplot(data=comp_nm_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="NMPD use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")


comp_2_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$comp_2_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$comp_2_6[data_d$cc_ind==1]==1,na.rm=TRUE),
          mean(data_d$comp_2_1==1,na.rm=TRUE),mean(data_d$comp_2_2==1,na.rm=TRUE),mean(data_d$comp_2_3==1,na.rm=TRUE),mean(data_d$comp_2_4==1,na.rm=TRUE),mean(data_d$comp_2_5==1,na.rm=TRUE),mean(data_d$comp_2_6==1,na.rm=TRUE),
                svymean(~comp_2_1,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_2,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_3,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_4,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_5,cc.svy, na.rm=TRUE)[2],
                svymean(~comp_2_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~comp_2_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~comp_2_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~comp_2_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~comp_2_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~comp_2_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~comp_2_6,fu6.svy, na.rm=TRUE)[2])))

names(comp_2_2)=c("type","Panel", "est")

comp_2_2$est=as.numeric(as.character(comp_2_2$est))

comp_2_d2=ggplot(data=comp_2_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Illicit drug use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")

B343_2=data.frame(cbind(rep(c("CC","AC","CC-attr-w","AC-attr-w"), each=6), rep(c( "19/20","21/22", "23/24","25/26", "27/28","29/30"),4),
                  c(mean(data_d$B343_1[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_2[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_3[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_4[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_5[data_d$cc_ind==1]==1,na.rm=TRUE),mean(data_d$B343_6[data_d$cc_ind==1]==1,na.rm=TRUE),
            mean(data_d$B343_1==1,na.rm=TRUE),mean(data_d$B343_2==1,na.rm=TRUE),mean(data_d$B343_3==1,na.rm=TRUE),mean(data_d$B343_4==1,na.rm=TRUE),mean(data_d$B343_5==1,na.rm=TRUE),mean(data_d$B343_6==1,na.rm=TRUE),
              svymean(~B343_1,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_2,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_3,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_4,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_5,cc.svy, na.rm=TRUE)[2],
                svymean(~B343_6,cc.svy, na.rm=TRUE)[2],     
            svymean(~B343_1,fu1.svy, na.rm=TRUE)[2],
                svymean(~B343_2,fu2.svy, na.rm=TRUE)[2],
                svymean(~B343_3,fu3.svy, na.rm=TRUE)[2],
                svymean(~B343_4,fu4.svy, na.rm=TRUE)[2],
                svymean(~B343_5,fu5.svy, na.rm=TRUE)[2],
                svymean(~B343_6,fu6.svy, na.rm=TRUE)[2])))

names(B343_2)=c("type","Panel", "est")

B343_2$est=as.numeric(as.character(B343_2$est))

B343_d2=ggplot(data=B343_2,aes(x=Panel, y=est, group=type, shape=type, color=type)) + 
  geom_point()+
  geom_line()+
  labs(title="Opioid use", y="Incidence", x="wave")+
  theme_bw() + theme(axis.text.x = element_text(size = 7), legend.title = element_blank(),legend.position = "bottom")
```


```{r dis-plot2, include=FALSE, warning=FALSE, message=FALSE}

melegend = g_legend(binge_d)
ggsave(grid.arrange(arrangeGrob(binge_d2 + theme(axis.text.x = element_text(size = 7), legend.position = "none"), B302_d2+theme(axis.text.x = element_text(size = 7), legend.position = "none"), B316_d2 + theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                                                  B343_d2 + theme(axis.text.x = element_text(size = 7), legend.position = "none"), 
                         comp_nm_d2 +  scale_y_continuous(breaks = c(0.13, 0.17, 0.21))+theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                         comp_2_d2 + theme(axis.text.x = element_text(size =7), legend.position = "none"),
ncol = 2
                         ), bottom=melegend,ncol=1),
width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-nobs.png")

ggsave(grid.arrange(arrangeGrob(binge_d2 +scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475)) + theme(axis.text.x = element_text(size = 7), legend.position = "none"), B302_d2+scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475))+theme(axis.text.x = element_text(size = 7), legend.position = "none"), B316_d2+scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475)) + theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                                                  B343_d2+scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475)) + theme(axis.text.x = element_text(size = 7), legend.position = "none"), 
                         comp_nm_d2+scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475)) +theme(axis.text.x = element_text(size = 7), legend.position = "none"),
                         comp_2_d2 +scale_y_continuous(breaks = c(0.1, 0.2, 0.3, 0.4), limits=c(0.05,0.475))+ theme(axis.text.x = element_text(size =7), legend.position = "none"),
ncol = 2
                         ), bottom=melegend,ncol=1),
width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/des-sum-nobs-samescale.png")
```
## complete case analysis

1. ignore the correlation among observations

```{r cc slr modeling, echo=FALSE, warning=FALSE, message=FALSE}

rm(list=ls()[!ls() %in% c("data_long", "g_legend")])

data_c=data_long[data_long$cc_ind==1,]


cc_0 = glm(binge ~ panel*coll + V101 + V34 + V350 + V351_rc + V364 + V379 +  marry + binge_0 + coll_0,  family="binomial", data=data_c)
summary(cc_0)

# cc_00 = glm(binge ~ panel*coll + V101+  V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +    marry + binge_0 + ASTRAT ,  family="binomial", data=data_c)
# 
# cc_00 = glm(binge ~ panel*coll + V101+  V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +    binge_0,  family="binomial", data=data_c)
# 
# cc_00 = glm(binge ~ panel*coll + V101+  V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +    binge_0 + ASTRAT ,  family="binomial", data=data_c)
# summary(cc_00)

#cplot(cc_0, x= "panel")

cc_0_c1 = glm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"),  family="binomial", data=data_c)

summary(cc_0_c1)
#summary(cc_0)$coef[c(2:7,(dim(summary(cc_0)$coef)[1]-5):dim(summary(cc_0)$coef)[1]),1]

#cc_use=cbind(exp(coef(cc_0)), exp(confint(cc_0,level = 0.95)))[c(2:7,(dim(summary(cc_0)$coef)[1]-5):dim(summary(cc_0)$coef)[1]),]

cc_use = rbind(rep(1,3),cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1,3),cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

# panel_m = data.frame(summary(margins(cc_0,variables = "panel",type="response",at=list(coll=unique(data_c$coll)))))
# 
# p_cc_m=ggplot(data = panel_m,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="AveME: binge drinking", y="", x="CC")+
#   theme_bw()  +theme(axis.text.x = element_text(size =6), legend.position = "none")
# # ggsave(width=5, height = 3, units="in", device="png", file="binge-uw.png")  
# #cplot(binge_cc_0,"panel")
# # 
binge_cc_v = glm(binge ~ coll + marry + panel +  V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
              V353 + V155 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
              V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342, family="binomial", data=data_c)
# # 
summary(binge_cc_v)
# # margins(binge_cc_v,variables = "panel",type="response")
# # #plot(margins(binge_cc_v,variables = "panel",type="response"))
# # cplot(binge_cc_v,"panel")

pre.out_0 =predict(cc_0,type="response")
pre.out_v =predict(binge_cc_v,type="response")

#roc(data_c$binge ~ pre.out_0, plot=TRUE, print.auc=TRUE)

```



2. GEE

```{r cc gee, echo=FALSE,warning=FALSE, message=FALSE}
gee_cc = geeglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")
summary(gee_cc)

# V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
#               V353 + V155 + V363 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
#               V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342

gee_cc_c1 = geeglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"),  id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")


gcc_use=rbind(rep(1,3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1,3),cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
    geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

pre.out_g =predict(gee_cc,type="response")

```

3. Incorporate base weight

```{r w-slr, echo=FALSE,warning=FALSE}

cc_svy1=svydesign(id= ~MTFID, weights= ~1, data = data_c, nest=T)

cc_svy_bw = svyglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, design=cc_svy1, family=quasibinomial)
summary(cc_svy_bw)

cc_svy_bw_c1 = svyglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

ccb_use=rbind(rep(1,3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1,3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))


ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

# panel_cc_svy_bw = data.frame(summary(margins(cc_svy_bw,variables = "panel",type="response",at=list(coll=unique(data_c$coll)))))
# 
# #panel_svy$factor=as.numeric(as.character(panel_svy$factor))
# p_ccb=ggplot(data = panel_cc_svy_bw,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="", y="", x="CC-ID cluster")+
#   theme_bw()+ theme(axis.text.x = element_text(size =6), legend.position = "none")
#ggsave(width=5, height = 3, units="in", device="png", file="binge-basew.png") 

pre.out_svy1 =predict(cc_svy_bw,type="response")



#cplot(binge_svy,design=cc_svy,"panel")
# binge_svy_v = svyglm(binge ~ coll + marry + panel +  V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+V353 + V155 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 + V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342,
# design=cc_svy, family=quasibinomial)
# summary(binge_svy_v)

```

4. Incorporate attrition-adjusted weight

```{r w-slr2, echo=FALSE,warning=FALSE}

cc_svy=svydesign(id= ~MTFID, weights= ~wgt_cc, data = data_c, nest=T)

cc_svy_aw = svyglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, design=cc_svy, family=quasibinomial)
summary(cc_svy_aw)

cc_svy_aw_c1 = svyglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ccw_use=rbind(rep(1,3),cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1,3),cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))


ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

# panel_cc_svy_aw = data.frame(summary(margins(cc_svy_aw,variables = "panel",type="response",at=list(coll=unique(data_c$coll)))))
# 
# #panel_svy$factor=as.numeric(as.character(panel_svy$factor))
# p_cca=ggplot(data = panel_cc_svy_aw,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="", y="", x="CC-attr-w")+
#   theme_bw()  +theme(axis.text.x = element_text(size =6), legend.position = "none")

pre.out_svy =predict(cc_svy_aw,type="response")

```

##Available case analysis

1. ignore the correlation among observations

```{r ac modeling, echo=FALSE, warning=FALSE, message=FALSE}
data_ac=data_long[!(is.na(data_long$binge)),]

#summary(data_ac$wgt_ac)
#sum(!(is.na(data_long$V1001)&is.na(data_long$V2001)&is.na(data_long$V3001)&is.na(data_long$V4001)&is.na(data_long$V5001)&is.na(data_long$V6001)))
#data_ac = data_long[]

ac_0 = glm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0,  family="binomial", data=data_ac)

summary(ac_0)

ac_0_c1 = glm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"),   family="binomial", data=data_ac)



ac_use=rbind(rep(1,3),cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1,3),cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


# 
# panel_ac_0 = data.frame(summary(margins(ac_0,variables = "panel",type="response",at=list(coll=unique(data_ac$coll)))))
# 
# #panel_svy$factor=as.numeric(as.character(panel_svy$factor))
# p_ac=ggplot(data = panel_ac_0,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="", y="", x="AC")+
#   theme_bw()
#ggsave(width=5, height = 3, units="in", device="png", file="binge-ac.png") 

#cplot(binge_ac_0,"panel")

# binge_ac_v = glm(binge ~ coll + marry + panel +  V101 + ASTRAT +V106  + V115 + V34 + V350+V351_rc+
#               V353 + V155 + V364 + V383 + V379 +V365 + V366 + V367 + V368 + V369 + V370+V372 + V375 + V376 + V377 + V379 + V380 + V381 + V382 + V383 +V384 + V391 + V392 + V393 + V394 + V395 + V396 + V397 + V398 + V399 + V400 + V401 + V402 + V403 + V404 +
#               V302 +V304 + V308 +V315 + V318 + V321 +V324 + V327 + V333 + V336 + V339 + V342, family="binomial", data=data_ac)
# 
# summary(binge_ac_v)
# margins(binge_ac_v,variables = "panel",type="response")
# #plot(margins(binge_ac_v,variables = "panel",type="response"))
# cplot(binge_ac_v,"panel")

pre.out_0_ac =predict(ac_0,type="response")
#pre.out_v_ac =predict(binge_ac_v,type="response")

#roc(data_ac$binge ~ pre.out_v_ac, plot=TRUE, print.auc=TRUE)

```


2. GEE

```{r ac gee, echo=FALSE,warning=FALSE, message=FALSE}
gee_ac = geeglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, id=MTFID, waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

summary(gee_ac)

gee_ac_c1 = geeglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

summary(gee_ac_c1)


gac_use=rbind(rep(1,3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1,3),cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
    geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

pre.out_g_ac =predict(gee_ac,type="response")




```

3. Incorporate base weights

```{r w-ac, echo=FALSE,warning=FALSE}

ac_svy_b=svydesign(id= ~MTFID, data = data_ac, nest=T)

ac_svy_bw = svyglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, design=ac_svy_b, family=quasibinomial)
summary(ac_svy_bw)

ac_svy_bw_c1 = svyglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

acb_use=rbind(rep(1,3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1,3),cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

# panel_ac_svy_bw = data.frame(summary(margins(ac_svy_bw,variables = "panel",type="response",at=list(coll=unique(data_ac$coll)))))
# 
# #panel_svy$factor=as.numeric(as.character(panel_svy$factor))
# p_acb=ggplot(data = panel_ac_svy_bw,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="", y="", x="AC-ID cluster")+
#   theme_bw()
# #ggsave(width=5, height = 3, units="in", device="png", file="binge-basew.png") 

pre.out_svy_ac_b =predict(ac_svy_bw,type="response")
#ggsave(width=5, height = 3, units="in", device="png", file="binge-basew-ac.png") 





```

4. Incorporate wave-specific weights

```{r w-ac-2, echo=FALSE,warning=FALSE}
ac_svy=svydesign(id= ~MTFID, weights= ~wgt_ac, data = data_ac, nest=T)

ac_svy_aw = svyglm(binge ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + coll_0, design=ac_svy, family=quasibinomial)
summary(ac_svy_aw)

ac_svy_aw_c1 = svyglm(binge ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + binge_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)

acw_use=rbind(rep(1,3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1,3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")

# panel_ac_svy_aw = data.frame(summary(margins(ac_svy_aw,variables = "panel",type="response",at=list(coll=unique(data_ac$coll)))))
# 
# #panel_svy$factor=as.numeric(as.character(panel_svy$factor))
# p_aca=ggplot(data = panel_ac_svy_aw,aes(x=factor, y=AME, group=coll, type=coll, color=coll)) + 
#   geom_point()+
#   geom_line()+
#   geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2)+
#   labs(title="", y="", x="AC-attr-w")+
#   theme_bw() 

pre.out_svy_ac =predict(ac_svy_aw,type="response")





```

#binge drinking

```{r, echo=FALSE}
# kable(
# data.frame(rbind(cbind(summary(cc_0)$coef[c(2:7,(dim(summary(cc_0)$coef)[1]-5):dim(summary(cc_0)$coef)[1]),1],
# summary(gee_cc)$coef[c(2:7,(dim(summary(gee_cc)$coef)[1]-5):dim(summary(gee_cc)$coef)[1]),1],
# summary(cc_svy_bw)$coef[c(2:7,(dim(summary(cc_svy_bw)$coef)[1]-5):dim(summary(cc_svy_bw)$coef)[1]),1],
# summary(cc_svy_aw)$coef[c(2:7,(dim(summary(cc_svy_aw)$coef)[1]-5):dim(summary(cc_svy_aw)$coef)[1]),1],
# summary(ac_0)$coef[c(2:7,(dim(summary(ac_0)$coef)[1]-5):dim(summary(ac_0)$coef)[1]),1],
# 
# summary(gee_ac)$coef[c(2:7,(dim(summary(gee_ac)$coef)[1]-5):dim(summary(gee_ac)$coef)[1]),1],
# summary(ac_svy_bw)$coef[c(2:7,(dim(summary(ac_svy_bw)$coef)[1]-5):dim(summary(ac_svy_bw)$coef)[1]),1],
# summary(ac_svy_aw)$coef[c(2:7,(dim(summary(ac_svy_aw)$coef)[1]-5):dim(summary(ac_svy_aw)$coef)[1]),1]),
# cbind(summary(cc_0)$coef[c(2:7,(dim(summary(cc_0)$coef)[1]-5):dim(summary(cc_0)$coef)[1]),4],
# summary(gee_cc)$coef[c(2:7,(dim(summary(gee_cc)$coef)[1]-5):dim(summary(gee_cc)$coef)[1]),4],
# summary(cc_svy_bw)$coef[c(2:7,(dim(summary(cc_svy_bw)$coef)[1]-5):dim(summary(cc_svy_bw)$coef)[1]),4],
# summary(cc_svy_aw)$coef[c(2:7,(dim(summary(cc_svy_aw)$coef)[1]-5):dim(summary(cc_svy_aw)$coef)[1]),4],
# summary(ac_0)$coef[c(2:7,(dim(summary(ac_0)$coef)[1]-5):dim(summary(ac_0)$coef)[1]),4],
# 
# summary(gee_ac)$coef[c(2:7,(dim(summary(gee_ac)$coef)[1]-5):dim(summary(gee_ac)$coef)[1]),4],
# summary(ac_svy_bw)$coef[c(2:7,(dim(summary(ac_svy_bw)$coef)[1]-5):dim(summary(ac_svy_bw)$coef)[1]),4],
# summary(ac_svy_aw)$coef[c(2:7,(dim(summary(ac_svy_aw)$coef)[1]-5):dim(summary(ac_svy_aw)$coef)[1]),4]))), col.names = c("CC", "CC-GEE","CC-ID cluster", "CC-attr-w","AC", "AC-GEE","AC-ID cluster", "AC-attr-w")
# )

# kable(
# data.frame(cbind(summary(cc_0)$coef[c(2:7,(dim(summary(cc_0)$coef)[1]-5):dim(summary(cc_0)$coef)[1]),c(1,4)],
# summary(gee_cc)$coef[c(2:7,(dim(summary(gee_cc)$coef)[1]-5):dim(summary(gee_cc)$coef)[1]),c(1,4)],
# summary(cc_svy_bw)$coef[c(2:7,(dim(summary(cc_svy_bw)$coef)[1]-5):dim(summary(cc_svy_bw)$coef)[1]),c(1,4)],
# summary(cc_svy_aw)$coef[c(2:7,(dim(summary(cc_svy_aw)$coef)[1]-5):dim(summary(cc_svy_aw)$coef)[1]),c(1,4)],
# summary(ac_0)$coef[c(2:7,(dim(summary(ac_0)$coef)[1]-5):dim(summary(ac_0)$coef)[1]),c(1,4)],
# 
# summary(gee_ac)$coef[c(2:7,(dim(summary(gee_ac)$coef)[1]-5):dim(summary(gee_ac)$coef)[1]),c(1,4)],
# summary(ac_svy_bw)$coef[c(2:7,(dim(summary(ac_svy_bw)$coef)[1]-5):dim(summary(ac_svy_bw)$coef)[1]),c(1,4)],
# summary(ac_svy_aw)$coef[c(2:7,(dim(summary(ac_svy_aw)$coef)[1]-5):dim(summary(ac_svy_aw)$coef)[1]),c(1,4)])), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
# )



kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw+ scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3)) + theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.2,2.4), breaks = c(1,2,3))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
                         ), bottom=tjlegend, top="Binge drinking",ncol=1),
width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/binge.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Binge drinking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/binge-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Binge drinking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/binge-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Binge drinking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/binge-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Binge drinking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/binge-p4.png")

as.numeric(auc(roc(data_c$binge ~ pre.out_0, print.auc=TRUE)))
as.numeric(auc(roc(data_c$binge ~ pre.out_g, print.auc=TRUE)))
as.numeric(auc(roc(data_c$binge ~ pre.out_svy1, print.auc=TRUE)))
as.numeric(auc(roc(data_c$binge ~ pre.out_svy, print.auc=TRUE)))
as.numeric(auc(roc(data_ac$binge ~ pre.out_0_ac, print.auc=TRUE)))
as.numeric(auc(roc(data_ac$binge ~ pre.out_g_ac, print.auc=TRUE)))
as.numeric(auc(roc(data_ac$binge ~ pre.out_svy_ac_b,print.auc=TRUE)))
as.numeric(auc(roc(data_ac$binge ~ pre.out_svy_ac, print.auc=TRUE)))
```

#smoking


```{r smoking, echo=FALSE, warning=FALSE, message=FALSE}


cc_0 = glm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0,  family="binomial", data=data_c)


gee_cc = geeglm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw = svyglm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0, design=cc_svy1, family=quasibinomial)

cc_svy_aw = svyglm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0,design=cc_svy, family=quasibinomial)

ac_0 = glm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0,  family="binomial", data=data_ac)

gee_ac = geeglm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw = svyglm(B302 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0, design=ac_svy_b, family=quasibinomial)

ac_svy_aw = svyglm(B302 ~panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + coll_0, design=ac_svy, family=quasibinomial)

summary(cc_0); summary(gee_cc); summary(cc_svy_bw); summary(cc_svy_aw); summary(ac_0); summary(gee_ac); summary(ac_svy_bw); summary(ac_svy_aw); 

cc_0_c1 = glm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_c)


gee_cc_c1 = geeglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw_c1 = svyglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

cc_svy_aw_c1 = svyglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ac_0_c1 = glm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_ac)

gee_ac_c1 = geeglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw_c1 = svyglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

ac_svy_aw_c1 = svyglm(B302 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B302_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)


kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

cc_use = rbind(rep(1, 3), cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1, 3), cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gcc_use=rbind(rep(1, 3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccb_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))

ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccw_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))

ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ac_use=rbind(rep(1, 3), cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1, 3), cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gac_use=rbind(rep(1, 3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

acb_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


acw_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")

tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc + scale_y_continuous(limits = c(0.25, 1.52),breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.25, 1.52), breaks = c(0.5, 1, 1.5))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc + scale_y_continuous(limits = c(0.25, 1.52),breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.25, 1.52), breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.25, 1.52),breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb + scale_y_continuous(limits = c(0.25, 1.52), breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw +scale_y_continuous(limits = c(0.25, 1.52),breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.25, 1.52), breaks = c(0.5, 1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
              ), bottom=tjlegend, top="Cigarette smoking",ncol=1),
       width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/smoking.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Cigarette smoking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/smoking-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Cigarette smoking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/smoking-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Cigarette smoking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/smoking-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Cigarette smoking",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/smoking-p4.png")
```


#marijuana


```{r marij, echo=FALSE, warning=FALSE, message=FALSE}

cc_0 = glm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0,  family="binomial", data=data_c)


gee_cc = geeglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw = svyglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0, design=cc_svy1, family=quasibinomial)

cc_svy_aw = svyglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0,design=cc_svy, family=quasibinomial)

ac_0 = glm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0,  family="binomial", data=data_ac)

gee_ac = geeglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw = svyglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0, design=ac_svy_b, family=quasibinomial)

ac_svy_aw = svyglm(B316 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + coll_0, design=ac_svy, family=quasibinomial)

summary(cc_0); summary(gee_cc); summary(cc_svy_bw); summary(cc_svy_aw); summary(ac_0); summary(gee_ac); summary(ac_svy_bw); summary(ac_svy_aw); 

cc_0_c1 = glm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"),  family="binomial", data=data_c)


gee_cc_c1 = geeglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw_c1 = svyglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

cc_svy_aw_c1 = svyglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ac_0_c1 = glm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_ac)

gee_ac_c1 = geeglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw_c1 = svyglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

ac_svy_aw_c1 = svyglm(B316 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B316_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)


kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

cc_use = rbind(rep(1, 3), cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1, 3), cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gcc_use=rbind(rep(1, 3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccb_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))

ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccw_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))

ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ac_use=rbind(rep(1, 3), cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1, 3), cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gac_use=rbind(rep(1, 3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

acb_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


acw_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")

tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc+ scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1)) + theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.48,1.3), breaks = c(0.5,1))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
                         ), bottom=tjlegend, top="Marijuana use",ncol=1),
width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/marijuana.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Marijuana use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/marijuana-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Marijuana use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/marijuana-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Marijuana use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/marijuana-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Marijuana use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/marijuana-p4.png")
```

#composite: AMPH, BRBT, TRQL, HEROIN,


```{r comp_nm, echo=FALSE, warning=FALSE, message=FALSE}
cc_0 = glm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0,  family="binomial", data=data_c)


gee_cc = geeglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw = svyglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0, design=cc_svy1, family=quasibinomial)

cc_svy_aw = svyglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0,design=cc_svy, family=quasibinomial)

ac_0 = glm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0,  family="binomial", data=data_ac)

gee_ac = geeglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw = svyglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0, design=ac_svy_b, family=quasibinomial)

ac_svy_aw = svyglm(comp_nm ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + coll_0, design=ac_svy, family=quasibinomial)

summary(cc_0); summary(gee_cc); summary(cc_svy_bw); summary(cc_svy_aw); summary(ac_0); summary(gee_ac); summary(ac_svy_bw); summary(ac_svy_aw); 

cc_0_c1 = glm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"),  family="binomial", data=data_c)


gee_cc_c1 = geeglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw_c1 = svyglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

cc_svy_aw_c1 = svyglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ac_0_c1 = glm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_ac)

gee_ac_c1 = geeglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw_c1 = svyglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

ac_svy_aw_c1 = svyglm(comp_nm ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_nm_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)


kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

cc_use = rbind(rep(1, 3), cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1, 3), cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gcc_use=rbind(rep(1, 3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccb_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))

ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccw_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))

ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ac_use=rbind(rep(1, 3), cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1, 3), cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gac_use=rbind(rep(1, 3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

acb_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


acw_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")


tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.6, 1.8), breaks = c(0.5,1,1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
                         ), bottom=tjlegend, top="NMPD use",ncol=1),
       width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/compnm.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="NMPD use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/compnm-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="NMPD use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/compnm-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="NMPD use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/compnm-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="NMPD use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/compnm-p4.png")
```


#composite: AMPH, BRBT, TRQL, NARC

```{r comp_2, echo=FALSE, warning=FALSE, message=FALSE}
cc_0 = glm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0,  family="binomial", data=data_c)


gee_cc = geeglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw = svyglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0, design=cc_svy1, family=quasibinomial)

cc_svy_aw = svyglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0,design=cc_svy, family=quasibinomial)

ac_0 = glm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0,  family="binomial", data=data_ac)

gee_ac = geeglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw = svyglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0, design=ac_svy_b, family=quasibinomial)

ac_svy_aw = svyglm(comp_2 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + coll_0, design=ac_svy, family=quasibinomial)

summary(cc_0); summary(gee_cc); summary(cc_svy_bw); summary(cc_svy_aw); summary(ac_0); summary(gee_ac); summary(ac_svy_bw); summary(ac_svy_aw); 

cc_0_c1 = glm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"),  family="binomial", data=data_c)


gee_cc_c1 = geeglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw_c1 = svyglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

cc_svy_aw_c1 = svyglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ac_0_c1 = glm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_ac)

gee_ac_c1 = geeglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw_c1 = svyglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

ac_svy_aw_c1 = svyglm(comp_2 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + comp_2_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)


kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

cc_use = rbind(rep(1, 3), cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1, 3), cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gcc_use=rbind(rep(1, 3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccb_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))

ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccw_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))

ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ac_use=rbind(rep(1, 3), cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1, 3), cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gac_use=rbind(rep(1, 3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

acb_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


acw_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")


tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb+ scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5)) + theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.3, 1.8), breaks = c(0.5,1, 1.5))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
                         ), bottom=tjlegend, top="Illicit drug use",ncol=1),
       width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/comp2.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Illicit drug use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/comp2-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Illicit drug use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/comp2-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Illicit drug use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/comp2-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Illicit drug use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/comp2-p4.png")

```

#NRAC

```{r 343, echo=FALSE, warning=FALSE,  message=FALSE}
cc_0 = glm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0,  family="binomial", data=data_c)


gee_cc = geeglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw = svyglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0, design=cc_svy1, family=quasibinomial)

cc_svy_aw = svyglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0,design=cc_svy, family=quasibinomial)

ac_0 = glm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0,  family="binomial", data=data_ac)

gee_ac = geeglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0, id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw = svyglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0, design=ac_svy_b, family=quasibinomial)

ac_svy_aw = svyglm(B343 ~ panel*coll + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + coll_0, design=ac_svy, family=quasibinomial)

summary(cc_0); summary(gee_cc); summary(cc_svy_bw); summary(cc_svy_aw); summary(ac_0); summary(gee_ac); summary(ac_svy_bw); summary(ac_svy_aw); 

cc_0_c1 = glm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"),  family="binomial", data=data_c)


gee_cc_c1 = geeglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_c, corstr = "ex")

cc_svy_bw_c1 = svyglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy1, family=quasibinomial)

cc_svy_aw_c1 = svyglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), design=cc_svy, family=quasibinomial)

ac_0_c1 = glm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), family="binomial", data=data_ac)

gee_ac_c1 = geeglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), id=MTFID,waves=panel, family=binomial("logit"), data=data_ac, corstr = "ex")

ac_svy_bw_c1 = svyglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy_b, family=quasibinomial)

ac_svy_aw_c1 = svyglm(B343 ~ panel*relevel(coll, ref="1") + V101 + V34 + V350 + relevel(V351_rc, ref="White") + V364 + V379 +  marry + B343_0 + relevel(factor(coll_0), ref = "1"), design=ac_svy, family=quasibinomial)


kable(
data.frame(cbind(rbind(summary(cc_0)$coef[2:7,c(1,4)],summary(cc_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_cc)$coef[2:7,c(1,4)],summary(gee_cc_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_bw)$coef[2:7,c(1,4)],summary(cc_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(cc_svy_aw)$coef[2:7,c(1,4)],summary(cc_svy_aw_c1)$coef[2:7,c(1,4)]),
rbind(summary(ac_0)$coef[2:7,c(1,4)],summary(ac_0_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(gee_ac)$coef[2:7,c(1,4)],summary(gee_ac_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_bw)$coef[2:7,c(1,4)],summary(ac_svy_bw_c1)$coef[2:7,c(1,4)]),
                 rbind(summary(ac_svy_aw)$coef[2:7,c(1,4)],summary(ac_svy_aw_c1)$coef[2:7,c(1,4)]))), col.names = c("CC", "p","CC-GEE","p","CC-ID cluster","p", "CC-attr-w","p","AC", "p","AC-GEE","p","AC-ID cluster", "p","AC-attr-w","p")
)

cc_use = rbind(rep(1, 3), cbind(exp(coef(cc_0)[2:6]), exp(confint(cc_0,level = 0.95)[2:6,])),rep(1, 3), cbind(exp(coef(cc_0_c1)[2:6]), exp(confint(cc_0_c1,level = 0.95)[2:6,])))

cc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),cc_use))

names(cc_est)=c("type","panel","or","orl","oru")

cc_est$or = as.numeric(as.character(cc_est$or))
cc_est$orl = as.numeric(as.character(cc_est$orl))
cc_est$oru = as.numeric(as.character(cc_est$oru))

p_cc=ggplot(data = cc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gcc_use=rbind(rep(1, 3), cbind(exp(coef(gee_cc)[2:6]), exp(summary(gee_cc)$coef[2:6,1]-1.96 * summary(gee_cc)$coef[2:6,2]),exp(summary(gee_cc)$coef[2:6,1]+1.96 * summary(gee_cc)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_cc_c1)[2:6]), exp(summary(gee_cc_c1)$coef[2:6,1]-1.96 * summary(gee_cc_c1)$coef[2:6,2]),exp(summary(gee_cc_c1)$coef[2:6,1]+1.96 * summary(gee_cc_c1)$coef[2:6,2])))

gcc_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gcc_use))

names(gcc_est)=c("type","panel","or","orl","oru")

gcc_est$or = as.numeric(as.character(gcc_est$or))
gcc_est$orl = as.numeric(as.character(gcc_est$orl))
gcc_est$oru = as.numeric(as.character(gcc_est$oru))

p_gcc=ggplot(data = gcc_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccb_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_bw)[2:6]), exp(confint(cc_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_bw_c1)[2:6]), exp(confint(cc_svy_bw_c1,level = 0.95)[2:6,])))

ccb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccb_use))

names(ccb_est)=c("type","panel","or","orl","oru")

ccb_est$or = as.numeric(as.character(ccb_est$or))
ccb_est$orl = as.numeric(as.character(ccb_est$orl))
ccb_est$oru = as.numeric(as.character(ccb_est$oru))

p_ccb=ggplot(data = ccb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ccw_use=rbind(rep(1, 3), cbind(exp(coef(cc_svy_aw)[2:6]), exp(confint(cc_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(cc_svy_aw_c1)[2:6]), exp(confint(cc_svy_aw_c1,level = 0.95)[2:6,])))

ccw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ccw_use))

names(ccw_est)=c("type","panel","or","orl","oru")

ccw_est$or = as.numeric(as.character(ccw_est$or))
ccw_est$orl = as.numeric(as.character(ccw_est$orl))
ccw_est$oru = as.numeric(as.character(ccw_est$oru))

p_ccw=ggplot(data = ccw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="Odds ratio", x="CC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

ac_use=rbind(rep(1, 3), cbind(exp(coef(ac_0)[2:6]), exp(confint(ac_0,level = 0.95)[2:6,])),
             rep(1, 3), cbind(exp(coef(ac_0_c1)[2:6]), exp(confint(ac_0_c1,level = 0.95)[2:6,])))

ac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),ac_use))

names(ac_est)=c("type","panel","or","orl","oru")

ac_est$or = as.numeric(as.character(ac_est$or))
ac_est$orl = as.numeric(as.character(ac_est$orl))
ac_est$oru = as.numeric(as.character(ac_est$oru))

p_ac=ggplot(data = ac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

gac_use=rbind(rep(1, 3), cbind(exp(coef(gee_ac)[2:6]), exp(summary(gee_ac)$coef[2:6,1]-1.96 * summary(gee_ac)$coef[2:6,2]),exp(summary(gee_ac)$coef[2:6,1]+1.96 * summary(gee_ac)$coef[2:6,2])),
              rep(1, 3), cbind(exp(coef(gee_ac_c1)[2:6]), exp(summary(gee_ac_c1)$coef[2:6,1]-1.96 * summary(gee_ac_c1)$coef[2:6,2]),exp(summary(gee_ac_c1)$coef[2:6,1]+1.96 * summary(gee_ac_c1)$coef[2:6,2])))

gac_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2), gac_use))

names(gac_est)=c("type","panel","or","orl","oru")

gac_est$or = as.numeric(as.character(gac_est$or))
gac_est$orl = as.numeric(as.character(gac_est$orl))
gac_est$oru = as.numeric(as.character(gac_est$oru))

p_gac=ggplot(data = gac_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-gee")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())

acb_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_bw)[2:6]), exp(confint(ac_svy_bw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_bw_c1)[2:6]), exp(confint(ac_svy_bw_c1,level = 0.95)[2:6,])))

acb_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acb_use))

names(acb_est)=c("type","panel","or","orl","oru")

acb_est$or = as.numeric(as.character(acb_est$or))
acb_est$orl = as.numeric(as.character(acb_est$orl))
acb_est$oru = as.numeric(as.character(acb_est$oru))

p_acb=ggplot(data = acb_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-ID cluster")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank())


acw_use=rbind(rep(1, 3), cbind(exp(coef(ac_svy_aw)[2:6]), exp(confint(ac_svy_aw,level = 0.95)[2:6,])),
              rep(1, 3), cbind(exp(coef(ac_svy_aw_c1)[2:6]), exp(confint(ac_svy_aw_c1,level = 0.95)[2:6,])))

acw_est = data.frame(cbind(rep(c("no-coll","coll"),each=6), rep(c("19/20","21/22", "23/24","25/26", "27/28","29/30"),2),acw_use))

names(acw_est)=c("type","panel","or","orl","oru")

acw_est$or = as.numeric(as.character(acw_est$or))
acw_est$orl = as.numeric(as.character(acw_est$orl))
acw_est$oru = as.numeric(as.character(acw_est$oru))

p_acw=ggplot(data = acw_est,aes(x=panel, y=or, group=type, shape=type, type=type, color=type)) + 
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=orl, ymax=oru), width=0.2)+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(title="", y="", x="AC-attr-w")+
  theme_bw()+ theme(axis.text.x = element_text(size =6), axis.title.y = element_text(size =7), legend.title = element_blank(), legend.position = "bottom")


tjlegend = g_legend(p_acw)
ggsave(grid.arrange(arrangeGrob(p_cc+ scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2)) + theme(axis.text.x = element_text(size = 6), legend.position = "none"), p_ac+ scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+theme(axis.text.x = element_text(size =6), legend.position = "none"), p_gcc + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                                                  p_gac + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"), 
                         p_ccb + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acb + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                        p_ccw + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
                         p_acw + scale_y_continuous(limits = c(0.2, 2.2), breaks = c(1,2))+ theme(axis.text.x = element_text(size =6), legend.position = "none"),
ncol = 2
                         ), bottom=tjlegend, top="Opioid use",ncol=1),
       width = 5, height = 6, units = "in", device="png", file="I:/WorkingProgramFiles/plot/0706/narc.png")

ggsave(grid.arrange(arrangeGrob(p_cc +theme(legend.position = "none"), p_ac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Opioid use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/narc-p1.png")

ggsave(grid.arrange(arrangeGrob(p_gcc +theme(legend.position = "none"), p_gac+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Opioid use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/narc-p2.png")

ggsave(grid.arrange(arrangeGrob(p_ccb +theme(legend.position = "none"), p_acb+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Opioid use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/narc-p3.png")

ggsave(grid.arrange(arrangeGrob(p_ccw +theme(legend.position = "none"), p_acw+ theme( legend.position = "none"), 
ncol = 2), bottom=tjlegend, top="Opioid use",ncol=1),
device="png", file="I:/WorkingProgramFiles/plot/0706/narc-p4.png")
```


```{r check, echo=FALSE}
 table(data_c$panel, data_c$coll)
  table(data_ac$panel, data_ac$coll)
  
  summary(data_c$wgt_cc[data_c$coll==1])
  summary(data_c$wgt_cc[data_c$coll==0])
  
  summary(data_c$wgt_ac[data_c$coll==1])
  summary(data_c$wgt_ac[data_c$coll==0])
  
```
